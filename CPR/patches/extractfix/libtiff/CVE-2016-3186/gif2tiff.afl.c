/* $Id$ */

/*
 * Copyright (c) 1990-1997 Sam Leffler
 * Copyright (c) 1991-1997 Silicon Graphics, Inc.
 *
 * Permission to use, copy, modify, distribute, and sell this software and 
 * its documentation for any purpose is hereby granted without fee, provided
 * that (i) the above copyright notices and this permission notice appear in
 * all copies of the software and related documentation, and (ii) the names of
 * Sam Leffler and Silicon Graphics may not be used in any advertising or
 * publicity relating to the software without the specific, prior written
 * permission of Sam Leffler and Silicon Graphics.
 * 
 * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, 
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  
 * 
 * IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR
 * ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,
 * OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
 * WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF 
 * LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE 
 * OF THIS SOFTWARE.
 */

/*
 *	convert a GIF file into a TIFF file.
 *	based on Paul Haeberli's fromgif program which in turn is
 *	based on a GIF file reader by Marcel J.E. Mol March 23 1989 
 *
 *	if input is 320 by 200 pixel aspect is probably 1.2
 *	if input is 640 350 pixel aspect is probably 1.37
 *
 */
#include "tif_config.h"

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <math.h>

int uni_klee_patch_id;

void klee_select_patch(int *patch_id) {
  *patch_id = atoi(getenv("DAFL_PATCH_ID"));
}

void uni_klee_add_patch(int *patch_results, int patch_id, int result) {
  patch_results[patch_id] = result;
}

int uni_klee_choice(int *patch_results, int patch_id) {
//   FILE *fp=fopen(getenv("DAFL_RESULT_FILE"),"a");
//   if (fp == NULL) {
//     fprintf(stderr, "Error opening file!\n");
//     exit(1);
//   }
//   fprintf(fp, "%d ", patch_results[patch_id]);
//   fclose(fp);
  return patch_results[patch_id];
}

// UNI_KLEE_START
int __cpr_choice(char* lid, char* typestr,
                     long long* rvals, char** rvals_ids, int rvals_size,
                     int** lvals, char** lvals_ids, int lvals_size){
  // int patch_results[4096];
  int result;
  long long x = rvals[0];
  long long y = rvals[1];
  long long constant_a;
  int patch_results[258];
  // Patch buggy # 0
  result = (1);
  uni_klee_add_patch(patch_results, 0, result);
  // Patch 1-0 # 1
  constant_a = -10;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 1, result);
  // Patch 1-1 # 2
  constant_a = -9;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 2, result);
  // Patch 1-2 # 3
  constant_a = -8;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 3, result);
  // Patch 1-3 # 4
  constant_a = -7;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 4, result);
  // Patch 1-4 # 5
  constant_a = -6;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 5, result);
  // Patch 1-5 # 6
  constant_a = -5;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 6, result);
  // Patch 1-6 # 7
  constant_a = -4;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 7, result);
  // Patch 1-7 # 8
  constant_a = -3;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 8, result);
  // Patch 1-8 # 9
  constant_a = -2;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 9, result);
  // Patch 1-9 # 10
  constant_a = -1;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 10, result);
  // Patch 1-10 # 11
  constant_a = 0;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 11, result);
  // Patch 1-11 # 12
  constant_a = 1;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 12, result);
  // Patch 1-12 # 13
  constant_a = 2;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 13, result);
  // Patch 1-13 # 14
  constant_a = 3;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 14, result);
  // Patch 1-14 # 15
  constant_a = 4;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 15, result);
  // Patch 1-15 # 16
  constant_a = 5;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 16, result);
  // Patch 1-16 # 17
  constant_a = 6;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 17, result);
  // Patch 1-17 # 18
  constant_a = 7;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 18, result);
  // Patch 1-18 # 19
  constant_a = 8;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 19, result);
  // Patch 1-19 # 20
  constant_a = 9;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 20, result);
  // Patch 1-20 # 21
  constant_a = 10;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 21, result);
  // Patch 2-0 # 22
  result = (y == x);
  uni_klee_add_patch(patch_results, 22, result);
  // Patch 3-0 # 23
  constant_a = -10;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 23, result);
  // Patch 3-1 # 24
  constant_a = -9;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 24, result);
  // Patch 3-2 # 25
  constant_a = -8;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 25, result);
  // Patch 3-3 # 26
  constant_a = -7;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 26, result);
  // Patch 3-4 # 27
  constant_a = -6;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 27, result);
  // Patch 3-5 # 28
  constant_a = -5;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 28, result);
  // Patch 3-6 # 29
  constant_a = -4;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 29, result);
  // Patch 3-7 # 30
  constant_a = -3;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 30, result);
  // Patch 3-8 # 31
  constant_a = -2;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 31, result);
  // Patch 3-9 # 32
  constant_a = -1;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 32, result);
  // Patch 3-10 # 33
  constant_a = 0;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 33, result);
  // Patch 3-11 # 34
  constant_a = 1;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 34, result);
  // Patch 3-12 # 35
  constant_a = 2;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 35, result);
  // Patch 3-13 # 36
  constant_a = 3;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 36, result);
  // Patch 3-14 # 37
  constant_a = 4;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 37, result);
  // Patch 3-15 # 38
  constant_a = 5;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 38, result);
  // Patch 3-16 # 39
  constant_a = 6;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 39, result);
  // Patch 3-17 # 40
  constant_a = 7;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 40, result);
  // Patch 3-18 # 41
  constant_a = 8;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 41, result);
  // Patch 3-19 # 42
  constant_a = 9;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 42, result);
  // Patch 3-20 # 43
  constant_a = 10;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 43, result);
  // Patch 4-0 # 44
  result = (x != x);
  uni_klee_add_patch(patch_results, 44, result);
  // Patch 5-0 # 45
  constant_a = -10;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 45, result);
  // Patch 5-1 # 46
  constant_a = -9;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 46, result);
  // Patch 5-2 # 47
  constant_a = -8;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 47, result);
  // Patch 5-3 # 48
  constant_a = -7;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 48, result);
  // Patch 5-4 # 49
  constant_a = -6;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 49, result);
  // Patch 5-5 # 50
  constant_a = -5;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 50, result);
  // Patch 5-6 # 51
  constant_a = -4;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 51, result);
  // Patch 5-7 # 52
  constant_a = -3;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 52, result);
  // Patch 5-8 # 53
  constant_a = -2;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 53, result);
  // Patch 5-9 # 54
  constant_a = -1;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 54, result);
  // Patch 5-10 # 55
  constant_a = 0;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 55, result);
  // Patch 5-11 # 56
  constant_a = 1;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 56, result);
  // Patch 5-12 # 57
  constant_a = 2;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 57, result);
  // Patch 5-13 # 58
  constant_a = 3;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 58, result);
  // Patch 5-14 # 59
  constant_a = 4;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 59, result);
  // Patch 5-15 # 60
  constant_a = 5;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 60, result);
  // Patch 5-16 # 61
  constant_a = 6;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 61, result);
  // Patch 5-17 # 62
  constant_a = 7;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 62, result);
  // Patch 5-18 # 63
  constant_a = 8;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 63, result);
  // Patch 5-19 # 64
  constant_a = 9;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 64, result);
  // Patch 5-20 # 65
  constant_a = 10;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 65, result);
  // Patch 6-0 # 66
  constant_a = -10;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 66, result);
  // Patch 6-1 # 67
  constant_a = -9;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 67, result);
  // Patch 6-2 # 68
  constant_a = -8;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 68, result);
  // Patch 6-3 # 69
  constant_a = -7;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 69, result);
  // Patch 6-4 # 70
  constant_a = -6;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 70, result);
  // Patch 6-5 # 71
  constant_a = -5;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 71, result);
  // Patch 6-6 # 72
  constant_a = -4;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 72, result);
  // Patch 6-7 # 73
  constant_a = -3;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 73, result);
  // Patch 6-8 # 74
  constant_a = -2;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 74, result);
  // Patch 6-9 # 75
  constant_a = -1;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 75, result);
  // Patch 6-10 # 76
  constant_a = 0;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 76, result);
  // Patch 6-11 # 77
  constant_a = 1;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 77, result);
  // Patch 6-12 # 78
  constant_a = 2;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 78, result);
  // Patch 6-13 # 79
  constant_a = 3;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 79, result);
  // Patch 6-14 # 80
  constant_a = 4;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 80, result);
  // Patch 6-15 # 81
  constant_a = 5;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 81, result);
  // Patch 6-16 # 82
  constant_a = 6;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 82, result);
  // Patch 6-17 # 83
  constant_a = 7;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 83, result);
  // Patch 6-18 # 84
  constant_a = 8;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 84, result);
  // Patch 6-19 # 85
  constant_a = 9;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 85, result);
  // Patch 6-20 # 86
  constant_a = 10;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 86, result);
  // Patch 7-0 # 87
  constant_a = -10;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 87, result);
  // Patch 7-1 # 88
  constant_a = -9;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 88, result);
  // Patch 7-2 # 89
  constant_a = -8;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 89, result);
  // Patch 7-3 # 90
  constant_a = -7;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 90, result);
  // Patch 7-4 # 91
  constant_a = -6;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 91, result);
  // Patch 7-5 # 92
  constant_a = -5;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 92, result);
  // Patch 7-6 # 93
  constant_a = -4;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 93, result);
  // Patch 7-7 # 94
  constant_a = -3;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 94, result);
  // Patch 7-8 # 95
  constant_a = -2;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 95, result);
  // Patch 7-9 # 96
  constant_a = -1;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 96, result);
  // Patch 7-10 # 97
  constant_a = 0;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 97, result);
  // Patch 7-11 # 98
  constant_a = 1;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 98, result);
  // Patch 7-12 # 99
  constant_a = 2;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 99, result);
  // Patch 7-13 # 100
  constant_a = 3;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 100, result);
  // Patch 7-14 # 101
  constant_a = 4;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 101, result);
  // Patch 7-15 # 102
  constant_a = 5;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 102, result);
  // Patch 7-16 # 103
  constant_a = 6;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 103, result);
  // Patch 7-17 # 104
  constant_a = 7;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 104, result);
  // Patch 7-18 # 105
  constant_a = 8;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 105, result);
  // Patch 7-19 # 106
  constant_a = 9;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 106, result);
  // Patch 7-20 # 107
  constant_a = 10;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 107, result);
  // Patch 8-0 # 108
  result = (y < x);
  uni_klee_add_patch(patch_results, 108, result);
  // Patch 9-0 # 109
  constant_a = -10;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 109, result);
  // Patch 9-1 # 110
  constant_a = -9;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 110, result);
  // Patch 9-2 # 111
  constant_a = -8;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 111, result);
  // Patch 9-3 # 112
  constant_a = -7;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 112, result);
  // Patch 9-4 # 113
  constant_a = -6;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 113, result);
  // Patch 9-5 # 114
  constant_a = -5;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 114, result);
  // Patch 9-6 # 115
  constant_a = -4;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 115, result);
  // Patch 9-7 # 116
  constant_a = -3;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 116, result);
  // Patch 9-8 # 117
  constant_a = -2;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 117, result);
  // Patch 9-9 # 118
  constant_a = -1;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 118, result);
  // Patch 9-10 # 119
  constant_a = 0;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 119, result);
  // Patch 9-11 # 120
  constant_a = 1;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 120, result);
  // Patch 9-12 # 121
  constant_a = 2;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 121, result);
  // Patch 9-13 # 122
  constant_a = 3;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 122, result);
  // Patch 9-14 # 123
  constant_a = 4;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 123, result);
  // Patch 9-15 # 124
  constant_a = 5;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 124, result);
  // Patch 9-16 # 125
  constant_a = 6;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 125, result);
  // Patch 9-17 # 126
  constant_a = 7;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 126, result);
  // Patch 9-18 # 127
  constant_a = 8;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 127, result);
  // Patch 9-19 # 128
  constant_a = 9;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 128, result);
  // Patch 9-20 # 129
  constant_a = 10;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 129, result);
  // Patch 10-0 # 130
  constant_a = -10;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 130, result);
  // Patch 10-1 # 131
  constant_a = -9;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 131, result);
  // Patch 10-2 # 132
  constant_a = -8;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 132, result);
  // Patch 10-3 # 133
  constant_a = -7;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 133, result);
  // Patch 10-4 # 134
  constant_a = -6;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 134, result);
  // Patch 10-5 # 135
  constant_a = -5;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 135, result);
  // Patch 10-6 # 136
  constant_a = -4;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 136, result);
  // Patch 10-7 # 137
  constant_a = -3;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 137, result);
  // Patch 10-8 # 138
  constant_a = -2;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 138, result);
  // Patch 10-9 # 139
  constant_a = -1;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 139, result);
  // Patch 10-10 # 140
  constant_a = 0;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 140, result);
  // Patch 10-11 # 141
  constant_a = 1;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 141, result);
  // Patch 10-12 # 142
  constant_a = 2;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 142, result);
  // Patch 10-13 # 143
  constant_a = 3;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 143, result);
  // Patch 10-14 # 144
  constant_a = 4;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 144, result);
  // Patch 10-15 # 145
  constant_a = 5;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 145, result);
  // Patch 10-16 # 146
  constant_a = 6;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 146, result);
  // Patch 10-17 # 147
  constant_a = 7;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 147, result);
  // Patch 10-18 # 148
  constant_a = 8;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 148, result);
  // Patch 10-19 # 149
  constant_a = 9;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 149, result);
  // Patch 10-20 # 150
  constant_a = 10;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 150, result);
  // Patch 11-0 # 151
  constant_a = -10;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 151, result);
  // Patch 11-1 # 152
  constant_a = -9;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 152, result);
  // Patch 11-2 # 153
  constant_a = -8;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 153, result);
  // Patch 11-3 # 154
  constant_a = -7;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 154, result);
  // Patch 11-4 # 155
  constant_a = -6;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 155, result);
  // Patch 11-5 # 156
  constant_a = -5;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 156, result);
  // Patch 11-6 # 157
  constant_a = -4;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 157, result);
  // Patch 11-7 # 158
  constant_a = -3;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 158, result);
  // Patch 11-8 # 159
  constant_a = -2;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 159, result);
  // Patch 11-9 # 160
  constant_a = -1;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 160, result);
  // Patch 11-10 # 161
  constant_a = 0;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 161, result);
  // Patch 11-11 # 162
  constant_a = 1;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 162, result);
  // Patch 11-12 # 163
  constant_a = 2;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 163, result);
  // Patch 11-13 # 164
  constant_a = 3;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 164, result);
  // Patch 11-14 # 165
  constant_a = 4;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 165, result);
  // Patch 11-15 # 166
  constant_a = 5;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 166, result);
  // Patch 11-16 # 167
  constant_a = 6;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 167, result);
  // Patch 11-17 # 168
  constant_a = 7;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 168, result);
  // Patch 11-18 # 169
  constant_a = 8;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 169, result);
  // Patch 11-19 # 170
  constant_a = 9;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 170, result);
  // Patch 11-20 # 171
  constant_a = 10;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 171, result);
  // Patch 12-0 # 172
  constant_a = -10;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 172, result);
  // Patch 12-1 # 173
  constant_a = -9;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 173, result);
  // Patch 12-2 # 174
  constant_a = -8;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 174, result);
  // Patch 12-3 # 175
  constant_a = -7;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 175, result);
  // Patch 12-4 # 176
  constant_a = -6;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 176, result);
  // Patch 12-5 # 177
  constant_a = -5;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 177, result);
  // Patch 12-6 # 178
  constant_a = -4;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 178, result);
  // Patch 12-7 # 179
  constant_a = -3;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 179, result);
  // Patch 12-8 # 180
  constant_a = -2;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 180, result);
  // Patch 12-9 # 181
  constant_a = -1;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 181, result);
  // Patch 12-10 # 182
  constant_a = 0;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 182, result);
  // Patch 12-11 # 183
  constant_a = 1;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 183, result);
  // Patch 12-12 # 184
  constant_a = 2;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 184, result);
  // Patch 12-13 # 185
  constant_a = 3;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 185, result);
  // Patch 12-14 # 186
  constant_a = 4;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 186, result);
  // Patch 12-15 # 187
  constant_a = 5;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 187, result);
  // Patch 12-16 # 188
  constant_a = 6;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 188, result);
  // Patch 12-17 # 189
  constant_a = 7;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 189, result);
  // Patch 12-18 # 190
  constant_a = 8;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 190, result);
  // Patch 12-19 # 191
  constant_a = 9;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 191, result);
  // Patch 12-20 # 192
  constant_a = 10;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 192, result);
  // Patch 13-0 # 193
  result = (y <= x);
  uni_klee_add_patch(patch_results, 193, result);
  // Patch 14-0 # 194
  constant_a = -10;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 194, result);
  // Patch 14-1 # 195
  constant_a = -9;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 195, result);
  // Patch 14-2 # 196
  constant_a = -8;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 196, result);
  // Patch 14-3 # 197
  constant_a = -7;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 197, result);
  // Patch 14-4 # 198
  constant_a = -6;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 198, result);
  // Patch 14-5 # 199
  constant_a = -5;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 199, result);
  // Patch 14-6 # 200
  constant_a = -4;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 200, result);
  // Patch 14-7 # 201
  constant_a = -3;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 201, result);
  // Patch 14-8 # 202
  constant_a = -2;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 202, result);
  // Patch 14-9 # 203
  constant_a = -1;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 203, result);
  // Patch 14-10 # 204
  constant_a = 0;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 204, result);
  // Patch 14-11 # 205
  constant_a = 1;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 205, result);
  // Patch 14-12 # 206
  constant_a = 2;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 206, result);
  // Patch 14-13 # 207
  constant_a = 3;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 207, result);
  // Patch 14-14 # 208
  constant_a = 4;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 208, result);
  // Patch 14-15 # 209
  constant_a = 5;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 209, result);
  // Patch 14-16 # 210
  constant_a = 6;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 210, result);
  // Patch 14-17 # 211
  constant_a = 7;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 211, result);
  // Patch 14-18 # 212
  constant_a = 8;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 212, result);
  // Patch 14-19 # 213
  constant_a = 9;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 213, result);
  // Patch 14-20 # 214
  constant_a = 10;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 214, result);
  // Patch 15-0 # 215
  constant_a = -10;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 215, result);
  // Patch 15-1 # 216
  constant_a = -9;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 216, result);
  // Patch 15-2 # 217
  constant_a = -8;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 217, result);
  // Patch 15-3 # 218
  constant_a = -7;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 218, result);
  // Patch 15-4 # 219
  constant_a = -6;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 219, result);
  // Patch 15-5 # 220
  constant_a = -5;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 220, result);
  // Patch 15-6 # 221
  constant_a = -4;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 221, result);
  // Patch 15-7 # 222
  constant_a = -3;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 222, result);
  // Patch 15-8 # 223
  constant_a = -2;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 223, result);
  // Patch 15-9 # 224
  constant_a = -1;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 224, result);
  // Patch 15-10 # 225
  constant_a = 0;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 225, result);
  // Patch 15-11 # 226
  constant_a = 1;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 226, result);
  // Patch 15-12 # 227
  constant_a = 2;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 227, result);
  // Patch 15-13 # 228
  constant_a = 3;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 228, result);
  // Patch 15-14 # 229
  constant_a = 4;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 229, result);
  // Patch 15-15 # 230
  constant_a = 5;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 230, result);
  // Patch 15-16 # 231
  constant_a = 6;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 231, result);
  // Patch 15-17 # 232
  constant_a = 7;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 232, result);
  // Patch 15-18 # 233
  constant_a = 8;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 233, result);
  // Patch 15-19 # 234
  constant_a = 9;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 234, result);
  // Patch 15-20 # 235
  constant_a = 10;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 235, result);
  // Patch 16-0 # 236
  constant_a = -10;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 236, result);
  // Patch 16-1 # 237
  constant_a = -9;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 237, result);
  // Patch 16-2 # 238
  constant_a = -8;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 238, result);
  // Patch 16-3 # 239
  constant_a = -7;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 239, result);
  // Patch 16-4 # 240
  constant_a = -6;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 240, result);
  // Patch 16-5 # 241
  constant_a = -5;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 241, result);
  // Patch 16-6 # 242
  constant_a = -4;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 242, result);
  // Patch 16-7 # 243
  constant_a = -3;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 243, result);
  // Patch 16-8 # 244
  constant_a = -2;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 244, result);
  // Patch 16-9 # 245
  constant_a = -1;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 245, result);
  // Patch 16-10 # 246
  constant_a = 0;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 246, result);
  // Patch 16-11 # 247
  constant_a = 1;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 247, result);
  // Patch 16-12 # 248
  constant_a = 2;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 248, result);
  // Patch 16-13 # 249
  constant_a = 3;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 249, result);
  // Patch 16-14 # 250
  constant_a = 4;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 250, result);
  // Patch 16-15 # 251
  constant_a = 5;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 251, result);
  // Patch 16-16 # 252
  constant_a = 6;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 252, result);
  // Patch 16-17 # 253
  constant_a = 7;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 253, result);
  // Patch 16-18 # 254
  constant_a = 8;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 254, result);
  // Patch 16-19 # 255
  constant_a = 9;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 255, result);
  // Patch 16-20 # 256
  constant_a = 10;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 256, result);
  // Patch correct # 257
  result = (x >= 0);
  uni_klee_add_patch(patch_results, 257, result);
  klee_select_patch(&uni_klee_patch_id);
  return uni_klee_choice(patch_results, uni_klee_patch_id);
}
// UNI_KLEE_END


#ifdef HAVE_UNISTD_H
# include <unistd.h>
#endif

#ifdef NEED_LIBPORT
# include "libport.h"
#endif

#include "tiffio.h"

#define	GIFGAMMA	(1.5)		/* smaller makes output img brighter */
#define	IMAX		0xffff		/* max intensity value */
#define EXTRAFUDGE	128		/* some people write BAD .gif files */

#define	streq(a,b)	(strcmp(a,b) == 0)
#define	strneq(a,b,n)	(strncmp(a,b,n) == 0)

unsigned short gamtab[256];

void
makegamtab(float gam)
{
    int i;

    for(i=0; i<256; i++) 
	gamtab[i] = (unsigned short) (IMAX*pow(i/255.0,gam)+0.5);
}

char* stuff[] = {
"usage: gif2tiff [options] input.gif output.tif",
"where options are:",
" -r #		make each strip have no more than # rows",
"",
" -c lzw[:opts]	compress output with Lempel-Ziv & Welch encoding",
" -c zip[:opts]	compress output with deflate encoding",
" -c packbits	compress output with packbits encoding",
" -c none	use no compression algorithm on output",
"",
"LZW and deflate options:",
" #		set predictor value",
"For example, -c lzw:2 to get LZW-encoded data with horizontal differencing",
NULL
};

static void
usage(void)
{
	char buf[BUFSIZ];
	int i;

	setbuf(stderr, buf);
        fprintf(stderr, "%s\n\n", TIFFGetVersion());
	for (i = 0; stuff[i] != NULL; i++)
		fprintf(stderr, "%s\n", stuff[i]);
	exit(-1);
}

#define COLSIZE 256

unsigned char *stackp;
unsigned int prefix[4096];
unsigned char suffix[4096];
unsigned char stack[4096];
int datasize,codesize,codemask;     /* Decoder working variables */
int clear,eoi;                      /* Special code values */
int avail, oldcode;

FILE *infile;
int global;                        /* Is there a global color map? */
int globalbits;                     /* Number of bits of global colors */
unsigned char globalmap[COLSIZE][3];/* RGB values for global color map */
unsigned char *raster;              /* Decoded image data */
unsigned long width, height;
unsigned short red[COLSIZE];
unsigned short green[COLSIZE];
unsigned short blue[COLSIZE];
char *filename, *imagename;

static	uint16 compression = COMPRESSION_PACKBITS;
static	uint16 predictor = 0;
static	uint32 rowsperstrip = (uint32) -1;
static	int processCompressOptions(char*);

int	convert(void);
int	checksignature(void);
int	readscreen(void);
int	readgifimage(char*);
int	readextension(void);
int	readraster(void);
int	process(int, unsigned char**);
void	initcolors(unsigned char [COLSIZE][3], int);
void	rasterize(int, char*);

int
main(int argc, char* argv[])
{
#if !HAVE_DECL_OPTARG
    extern int optind;
    extern char *optarg;
#endif

    int c, status;

    while ((c = getopt(argc, argv, "c:r:")) != -1)
	    switch (c) {
	    case 'c':		/* compression scheme */
		    if (!processCompressOptions(optarg))
			    usage();
		    break;
	    case 'r':		/* rows/strip */
		    rowsperstrip = atoi(optarg);
		    break;
	    case '?':
		    usage();
		    /*NOTREACHED*/
	    }
    if (argc - optind != 2)
	    usage();

    makegamtab(GIFGAMMA);
    filename = argv[optind];
    imagename = argv[optind+1];
    if ((infile = fopen(imagename, "rb")) != NULL) {
	int c;
	fclose(infile);
	printf("overwrite %s? ", imagename); fflush(stdout);
	c = getc(stdin);
	if (c != 'y' && c != 'Y')
	    return (1);
    }
    if ((infile = fopen(filename, "rb")) == NULL) {
	perror(filename);
	return (1);
    }
    status = convert();
    fclose(infile);
    return (status);
}

static int
processCompressOptions(char* opt)
{
	if (streq(opt, "none"))
		compression = COMPRESSION_NONE;
	else if (streq(opt, "packbits"))
		compression = COMPRESSION_PACKBITS;
	else if (strneq(opt, "lzw", 3)) {
		char* cp = strchr(opt, ':');
		if (cp)
			predictor = atoi(cp+1);
		compression = COMPRESSION_LZW;
	} else if (strneq(opt, "zip", 3)) {
		char* cp = strchr(opt, ':');
		if (cp)
			predictor = atoi(cp+1);
		compression = COMPRESSION_DEFLATE;
	} else
		return (0);
	return (1);
}

int
convert(void)
{
    int ch;
    char* mode = "w";

    if (!checksignature())
        return (-1);
    if (!readscreen())
        return (-1);
    while ((ch = getc(infile)) != ';' && ch != EOF) {
        switch (ch) {
            case '\0':  break;  /* this kludge for non-standard files */
            case ',':   if (!readgifimage(mode))
                           return (-1);
			mode = "a";		/* subsequent images append */
                        break;
        case '!':   if (!readextension())
                            return (-1);
                        break;
            default:    fprintf(stderr, "illegal GIF block type\n");
                        return (-1);
        }
    }
    return (0);
}

int
checksignature(void)
{
    char buf[6];

    if (fread(buf,1,6,infile) != 6) {
        fprintf(stderr, "short read from file %s (%s)\n",
                filename, strerror(errno));
        return 0;
    }
    if (strncmp(buf,"GIF",3)) {
        fprintf(stderr, "file is not a GIF file\n");
        return 0;
    }
    if (strncmp(&buf[3],"87a",3)) {
        fprintf(stderr, "unknown GIF version number\n");
        return 0;
    }
    return 1;
}

/*
 * 	readscreen - 
 *		Get information which is global to all the images stored 
 *	in the file
 */
int
readscreen(void)
{
    unsigned char buf[7];

    if (fread(buf,1,7,infile) != 7) {
        fprintf(stderr, "short read from file %s (%s)\n",
                filename, strerror(errno));
        return 0;
    }
    global = buf[4] & 0x80;
    if (global) {
        globalbits = (buf[4] & 0x07) + 1;
        if (fread(globalmap,3,((size_t)1)<<globalbits,infile) !=
            ((size_t)1)<<globalbits) {
            fprintf(stderr, "short read from file %s (%s)\n",
                    filename, strerror(errno));
            return 0;
        }
    }
    return 1;
}

int
readgifimage(char* mode)
{
    unsigned char buf[9];
    int local, interleaved;
    unsigned char localmap[256][3];
    int localbits;
    int status;
    size_t raster_size;

    if (fread(buf, 1, 9, infile) != 9) {
        fprintf(stderr, "short read from file %s (%s)\n",
                filename, strerror(errno));
	return (0);
    }
    width = (buf[4] + (buf[5] << 8)) & 0xffff; /* 16 bit */
    height = (buf[6] + (buf[7] << 8)) & 0xffff;  /* 16 bit */
    local = buf[8] & 0x80;
    interleaved = buf[8] & 0x40;
    if (width == 0UL || height == 0UL || (width > 2000000000UL / height)) {
        fprintf(stderr, "Invalid value of width or height\n");
        return(0);
    }
    if (local == 0 && global == 0) {
        fprintf(stderr, "no colormap present for image\n");
        return (0);
    }
    raster_size=width*height;
    if ((raster_size/width) == height) {
        raster_size += EXTRAFUDGE;  /* Add elbow room */
    } else {
        raster_size=0;
    }
    if ((raster = (unsigned char*) _TIFFmalloc(raster_size)) == NULL) {
        fprintf(stderr, "not enough memory for image\n");
        return (0);
    }
    if (local) {
        localbits = (buf[8] & 0x7) + 1;

        fprintf(stderr, "   local colors: %d\n", 1<<localbits);

        if (fread(localmap, 3, ((size_t)1)<<localbits, infile) !=
            ((size_t)1)<<localbits) {
            fprintf(stderr, "short read from file %s (%s)\n",
                    filename, strerror(errno));
            return (0);
        }
        initcolors(localmap, 1<<localbits);
    } else if (global) {
        initcolors(globalmap, 1<<globalbits);
    }
    if ((status = readraster()))
	rasterize(interleaved, mode);
    _TIFFfree(raster);
    return status;
}

/*
 * 	readextension -
 *		Read a GIF extension block (and do nothing with it).
 *
 */
int
readextension(void)
{
    int count;
    char buf[255];
    int status = 1;

    (void) getc(infile);
while ((count = getc(infile)) &&  count <= 255 && (__cpr_choice("L65", "bool", (long long[]){count, status}, (char*[]){"x", "y"}, 2, (int*[]){}, (char*[]){}, 0)) )
{
 if (count < 0) abort();

        if (fread(buf, 1, count, infile) != (size_t) count) {
            fprintf(stderr, "short read from file %s (%s)\n",
                    filename, strerror(errno));
            status = 0;
            break;
}
        }
    return status;
}

/*
 * 	readraster -
 *		Decode a raster image
 *
 */
int
readraster(void)
{
    unsigned char *fill = raster;
    unsigned char buf[255];
    register int bits=0;
    register unsigned long datum=0;
    register unsigned char *ch;
    register int count, code;
    int status = 1;

    datasize = getc(infile);
    if (datasize > 12)
	return 0;
    clear = 1 << datasize;
    eoi = clear + 1;
    avail = clear + 2;
    oldcode = -1;
    codesize = datasize + 1;
    codemask = (1 << codesize) - 1;
    for (code = 0; code < clear; code++) {
	prefix[code] = 0;
	suffix[code] = code;
    }
    stackp = stack;
    for (count = getc(infile); count > 0 && count <= 255; count = getc(infile)) {
	if (fread(buf,1,count,infile) != (size_t)count) {
            fprintf(stderr, "short read from file %s (%s)\n",
                    filename, strerror(errno));
            return 0;
        }
	for (ch=buf; count-- > 0; ch++) {
	    datum += (unsigned long) *ch << bits;
	    bits += 8;
	    while (bits >= codesize) {
		code = datum & codemask;
		datum >>= codesize;
		bits -= codesize;
		if (code == eoi) {               /* This kludge put in */
		    goto exitloop;               /* because some GIF files*/
		}                                /* aren't standard */
		if (!process(code, &fill)) {
		    status = 0;
		    goto exitloop;
		}
	    }
	}
	if (fill >= raster + width*height) {
	    fprintf(stderr, "raster full before eoi code\n");
	    break;
	}
    }
exitloop:
    if (fill != raster + width*height)  {
	fprintf(stderr, "warning: wrong rastersize: %ld bytes\n",
						      (long) (fill-raster));
	fprintf(stderr, "         instead of %ld bytes\n",
						      (long) width*height);
    }
    return status;
}

/*
 * 	process - 
 *		Process a compression code.  "clear" resets the code table.  
 *	Otherwise make a new code table entry, and output the bytes 
 *	associated with the code.
 */
int
process(register int code, unsigned char** fill)
{
    int incode;
    static unsigned char firstchar;

    if (code == clear) {
	codesize = datasize + 1;
	codemask = (1 << codesize) - 1;
	avail = clear + 2;
	oldcode = -1;
	return 1;
    }

    if (oldcode == -1) {
        if (code >= clear) {
            fprintf(stderr, "bad input: code=%d is larger than clear=%d\n",code, clear);
            return 0;
        }
        if (*fill >= raster + width*height) {
            fprintf(stderr, "raster full before eoi code\n");
            return 0;
        }
	*(*fill)++ = suffix[code];
	firstchar = oldcode = code;
	return 1;
    }
    if (code > avail) {
	fprintf(stderr, "code %d too large for %d\n", code, avail);
	return 0; 
    }

    incode = code;
    if (code == avail) {      /* the first code is always < avail */
	*stackp++ = firstchar;
	code = oldcode;
    }
    while (code > clear) {
	*stackp++ = suffix[code];
	code = prefix[code];
    }

    *stackp++ = firstchar = suffix[code];
    prefix[avail] = oldcode;
    suffix[avail] = firstchar;
    avail++;

    if (((avail & codemask) == 0) && (avail < 4096)) {
	codesize++;
	codemask += avail;
    }
    oldcode = incode;
    do {
        if (*fill >= raster + width*height) {
            fprintf(stderr, "raster full before eoi code\n");
            return 0;
        }
	*(*fill)++ = *--stackp;
    } while (stackp > stack);
    return 1;
}

/*
 * 	initcolors -
 *		Convert a color map (local or global) to arrays with R, G and B
 * 	values. 
 *
 */
void
initcolors(unsigned char colormap[COLSIZE][3], int ncolors)
{
    register int i;

    for (i = 0; i < ncolors; i++) {
        red[i]   = gamtab[colormap[i][0]];
        green[i] = gamtab[colormap[i][1]];
        blue[i]  = gamtab[colormap[i][2]];
    }
}

void
rasterize(int interleaved, char* mode)
{
    register unsigned long row;
    unsigned char *newras;
    unsigned char *ras;
    TIFF *tif;
    tstrip_t strip;
    tsize_t stripsize;

    if ((newras = (unsigned char*) _TIFFmalloc(width*height+EXTRAFUDGE)) == NULL) {
        fprintf(stderr, "not enough memory for image\n");
        return;
    }
#define DRAWSEGMENT(offset, step) {			\
        for (row = offset; row < height; row += step) {	\
            _TIFFmemcpy(newras + row*width, ras, width);\
            ras += width;                            	\
        }						\
    }
    ras = raster;
    if (interleaved) {
        DRAWSEGMENT(0, 8);
        DRAWSEGMENT(4, 8);
        DRAWSEGMENT(2, 4);
        DRAWSEGMENT(1, 2);
    } else 
        DRAWSEGMENT(0, 1);
#undef DRAWSEGMENT

    tif = TIFFOpen(imagename, mode);
    if (!tif) {
	TIFFError(imagename,"Can not open output image");
	exit(-1);
    }
    TIFFSetField(tif, TIFFTAG_IMAGEWIDTH, (uint32) width);
    TIFFSetField(tif, TIFFTAG_IMAGELENGTH, (uint32) height);
    TIFFSetField(tif, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_PALETTE);
    TIFFSetField(tif, TIFFTAG_PLANARCONFIG, PLANARCONFIG_CONTIG);
    TIFFSetField(tif, TIFFTAG_SAMPLESPERPIXEL, 1);
    TIFFSetField(tif, TIFFTAG_BITSPERSAMPLE, 8);
    TIFFSetField(tif, TIFFTAG_ROWSPERSTRIP, 
	rowsperstrip = TIFFDefaultStripSize(tif, rowsperstrip));
    TIFFSetField(tif, TIFFTAG_COMPRESSION, compression);
    switch (compression) {
    case COMPRESSION_LZW:
    case COMPRESSION_DEFLATE:
	    if (predictor != 0)
		    TIFFSetField(tif, TIFFTAG_PREDICTOR, predictor);
	    break;
    }
    TIFFSetField(tif, TIFFTAG_COLORMAP, red, green, blue);
    TIFFSetField(tif, TIFFTAG_ORIENTATION, ORIENTATION_TOPLEFT);
    strip = 0;
    stripsize = TIFFStripSize(tif);
    for (row=0; row<height; row += rowsperstrip) {
	if (rowsperstrip > height-row) {
	    rowsperstrip = height-row;
	    stripsize = TIFFVStripSize(tif, rowsperstrip);
	}
	if (TIFFWriteEncodedStrip(tif, strip, newras+row*width, stripsize) < 0)
	    break;
	strip++;
    }
    TIFFClose(tif);

    _TIFFfree(newras);
}

/* vim: set ts=8 sts=8 sw=8 noet: */
/*
 * Local Variables:
 * mode: c
 * c-basic-offset: 4
 * fill-column: 78
 * End:
 */
