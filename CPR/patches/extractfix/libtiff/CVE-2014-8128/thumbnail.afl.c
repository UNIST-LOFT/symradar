/* $Id$ */

/*
 * Copyright (c) 1994-1997 Sam Leffler
 * Copyright (c) 1994-1997 Silicon Graphics, Inc.
 *
 * Permission to use, copy, modify, distribute, and sell this software and 
 * its documentation for any purpose is hereby granted without fee, provided
 * that (i) the above copyright notices and this permission notice appear in
 * all copies of the software and related documentation, and (ii) the names of
 * Sam Leffler and Silicon Graphics may not be used in any advertising or
 * publicity relating to the software without the specific, prior written
 * permission of Sam Leffler and Silicon Graphics.
 * 
 * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, 
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  
 * 
 * IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR
 * ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,
 * OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
 * WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF 
 * LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE 
 * OF THIS SOFTWARE.
 */

#include "tif_config.h"

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

int uni_klee_patch_id;

void klee_select_patch(int *patch_id) {
  *patch_id = atoi(getenv("DAFL_PATCH_ID"));
}

void uni_klee_add_patch(int *patch_results, int patch_id, int result) {
  patch_results[patch_id] = result;
}

int uni_klee_choice(int *patch_results, int patch_id) {
//   FILE *fp=fopen(getenv("DAFL_RESULT_FILE"),"a");
//   if (fp == NULL) {
//     fprintf(stderr, "Error opening file!\n");
//     exit(1);
//   }
//   fprintf(fp, "%d ", patch_results[patch_id]);
//   fclose(fp);
  return patch_results[patch_id];
}

// UNI_KLEE_START
int __cpr_choice(char* lid, char* typestr,
                     long long* rvals, char** rvals_ids, int rvals_size,
                     int** lvals, char** lvals_ids, int lvals_size){
  // int patch_results[4096];
  int result;
  long long x = rvals[0];
  long long y = rvals[1];
  long long constant_a;
  int patch_results[262];
  // Patch buggy # 0
  result = (1);
  uni_klee_add_patch(patch_results, 0, result);
  // Patch 1-0 # 1
  result = (x == x);
  uni_klee_add_patch(patch_results, 1, result);
  // Patch 2-0 # 2
  result = (y == x);
  uni_klee_add_patch(patch_results, 2, result);
  // Patch 3-0 # 3
  constant_a = -10;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 3, result);
  // Patch 3-1 # 4
  constant_a = -9;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 4, result);
  // Patch 3-2 # 5
  constant_a = -8;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 5, result);
  // Patch 3-3 # 6
  constant_a = -7;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 6, result);
  // Patch 3-4 # 7
  constant_a = -6;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 7, result);
  // Patch 3-5 # 8
  constant_a = -5;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 8, result);
  // Patch 3-6 # 9
  constant_a = -4;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 9, result);
  // Patch 3-7 # 10
  constant_a = -3;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 10, result);
  // Patch 3-8 # 11
  constant_a = -2;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 11, result);
  // Patch 3-9 # 12
  constant_a = -1;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 12, result);
  // Patch 3-10 # 13
  constant_a = 0;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 13, result);
  // Patch 3-11 # 14
  constant_a = 1;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 14, result);
  // Patch 3-12 # 15
  constant_a = 2;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 15, result);
  // Patch 3-13 # 16
  constant_a = 3;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 16, result);
  // Patch 3-14 # 17
  constant_a = 4;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 17, result);
  // Patch 3-15 # 18
  constant_a = 5;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 18, result);
  // Patch 3-16 # 19
  constant_a = 6;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 19, result);
  // Patch 3-17 # 20
  constant_a = 7;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 20, result);
  // Patch 3-18 # 21
  constant_a = 8;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 21, result);
  // Patch 3-19 # 22
  constant_a = 9;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 22, result);
  // Patch 3-20 # 23
  constant_a = 10;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 23, result);
  // Patch 4-0 # 24
  constant_a = -10;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 24, result);
  // Patch 4-1 # 25
  constant_a = -9;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 25, result);
  // Patch 4-2 # 26
  constant_a = -8;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 26, result);
  // Patch 4-3 # 27
  constant_a = -7;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 27, result);
  // Patch 4-4 # 28
  constant_a = -6;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 28, result);
  // Patch 4-5 # 29
  constant_a = -5;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 29, result);
  // Patch 4-6 # 30
  constant_a = -4;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 30, result);
  // Patch 4-7 # 31
  constant_a = -3;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 31, result);
  // Patch 4-8 # 32
  constant_a = -2;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 32, result);
  // Patch 4-9 # 33
  constant_a = -1;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 33, result);
  // Patch 4-10 # 34
  constant_a = 0;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 34, result);
  // Patch 4-11 # 35
  constant_a = 1;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 35, result);
  // Patch 4-12 # 36
  constant_a = 2;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 36, result);
  // Patch 4-13 # 37
  constant_a = 3;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 37, result);
  // Patch 4-14 # 38
  constant_a = 4;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 38, result);
  // Patch 4-15 # 39
  constant_a = 5;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 39, result);
  // Patch 4-16 # 40
  constant_a = 6;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 40, result);
  // Patch 4-17 # 41
  constant_a = 7;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 41, result);
  // Patch 4-18 # 42
  constant_a = 8;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 42, result);
  // Patch 4-19 # 43
  constant_a = 9;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 43, result);
  // Patch 4-20 # 44
  constant_a = 10;
  result = (constant_a == y);
  uni_klee_add_patch(patch_results, 44, result);
  // Patch 5-0 # 45
  result = (x != x);
  uni_klee_add_patch(patch_results, 45, result);
  // Patch 6-0 # 46
  result = (y != x);
  uni_klee_add_patch(patch_results, 46, result);
  // Patch 7-0 # 47
  constant_a = -10;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 47, result);
  // Patch 7-1 # 48
  constant_a = -9;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 48, result);
  // Patch 7-2 # 49
  constant_a = -8;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 49, result);
  // Patch 7-3 # 50
  constant_a = -7;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 50, result);
  // Patch 7-4 # 51
  constant_a = -6;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 51, result);
  // Patch 7-5 # 52
  constant_a = -5;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 52, result);
  // Patch 7-6 # 53
  constant_a = -4;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 53, result);
  // Patch 7-7 # 54
  constant_a = -3;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 54, result);
  // Patch 7-8 # 55
  constant_a = -2;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 55, result);
  // Patch 7-9 # 56
  constant_a = -1;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 56, result);
  // Patch 7-10 # 57
  constant_a = 0;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 57, result);
  // Patch 7-11 # 58
  constant_a = 1;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 58, result);
  // Patch 7-12 # 59
  constant_a = 2;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 59, result);
  // Patch 7-13 # 60
  constant_a = 3;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 60, result);
  // Patch 7-14 # 61
  constant_a = 4;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 61, result);
  // Patch 7-15 # 62
  constant_a = 5;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 62, result);
  // Patch 7-16 # 63
  constant_a = 6;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 63, result);
  // Patch 7-17 # 64
  constant_a = 7;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 64, result);
  // Patch 7-18 # 65
  constant_a = 8;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 65, result);
  // Patch 7-19 # 66
  constant_a = 9;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 66, result);
  // Patch 7-20 # 67
  constant_a = 10;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 67, result);
  // Patch 8-0 # 68
  constant_a = -10;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 68, result);
  // Patch 8-1 # 69
  constant_a = -9;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 69, result);
  // Patch 8-2 # 70
  constant_a = -8;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 70, result);
  // Patch 8-3 # 71
  constant_a = -7;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 71, result);
  // Patch 8-4 # 72
  constant_a = -6;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 72, result);
  // Patch 8-5 # 73
  constant_a = -5;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 73, result);
  // Patch 8-6 # 74
  constant_a = -4;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 74, result);
  // Patch 8-7 # 75
  constant_a = -3;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 75, result);
  // Patch 8-8 # 76
  constant_a = -2;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 76, result);
  // Patch 8-9 # 77
  constant_a = -1;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 77, result);
  // Patch 8-10 # 78
  constant_a = 0;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 78, result);
  // Patch 8-11 # 79
  constant_a = 1;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 79, result);
  // Patch 8-12 # 80
  constant_a = 2;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 80, result);
  // Patch 8-13 # 81
  constant_a = 3;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 81, result);
  // Patch 8-14 # 82
  constant_a = 4;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 82, result);
  // Patch 8-15 # 83
  constant_a = 5;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 83, result);
  // Patch 8-16 # 84
  constant_a = 6;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 84, result);
  // Patch 8-17 # 85
  constant_a = 7;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 85, result);
  // Patch 8-18 # 86
  constant_a = 8;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 86, result);
  // Patch 8-19 # 87
  constant_a = 9;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 87, result);
  // Patch 8-20 # 88
  constant_a = 10;
  result = (constant_a != y);
  uni_klee_add_patch(patch_results, 88, result);
  // Patch 9-0 # 89
  result = (y < x);
  uni_klee_add_patch(patch_results, 89, result);
  // Patch 10-0 # 90
  constant_a = -10;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 90, result);
  // Patch 10-1 # 91
  constant_a = -9;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 91, result);
  // Patch 10-2 # 92
  constant_a = -8;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 92, result);
  // Patch 10-3 # 93
  constant_a = -7;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 93, result);
  // Patch 10-4 # 94
  constant_a = -6;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 94, result);
  // Patch 10-5 # 95
  constant_a = -5;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 95, result);
  // Patch 10-6 # 96
  constant_a = -4;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 96, result);
  // Patch 10-7 # 97
  constant_a = -3;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 97, result);
  // Patch 10-8 # 98
  constant_a = -2;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 98, result);
  // Patch 10-9 # 99
  constant_a = -1;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 99, result);
  // Patch 10-10 # 100
  constant_a = 0;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 100, result);
  // Patch 10-11 # 101
  constant_a = 1;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 101, result);
  // Patch 10-12 # 102
  constant_a = 2;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 102, result);
  // Patch 10-13 # 103
  constant_a = 3;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 103, result);
  // Patch 10-14 # 104
  constant_a = 4;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 104, result);
  // Patch 10-15 # 105
  constant_a = 5;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 105, result);
  // Patch 10-16 # 106
  constant_a = 6;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 106, result);
  // Patch 10-17 # 107
  constant_a = 7;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 107, result);
  // Patch 10-18 # 108
  constant_a = 8;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 108, result);
  // Patch 10-19 # 109
  constant_a = 9;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 109, result);
  // Patch 10-20 # 110
  constant_a = 10;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 110, result);
  // Patch 11-0 # 111
  result = (x < y);
  uni_klee_add_patch(patch_results, 111, result);
  // Patch 12-0 # 112
  constant_a = -10;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 112, result);
  // Patch 12-1 # 113
  constant_a = -9;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 113, result);
  // Patch 12-2 # 114
  constant_a = -8;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 114, result);
  // Patch 12-3 # 115
  constant_a = -7;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 115, result);
  // Patch 12-4 # 116
  constant_a = -6;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 116, result);
  // Patch 12-5 # 117
  constant_a = -5;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 117, result);
  // Patch 12-6 # 118
  constant_a = -4;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 118, result);
  // Patch 12-7 # 119
  constant_a = -3;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 119, result);
  // Patch 12-8 # 120
  constant_a = -2;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 120, result);
  // Patch 12-9 # 121
  constant_a = -1;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 121, result);
  // Patch 12-10 # 122
  constant_a = 0;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 122, result);
  // Patch 12-11 # 123
  constant_a = 1;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 123, result);
  // Patch 12-12 # 124
  constant_a = 2;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 124, result);
  // Patch 12-13 # 125
  constant_a = 3;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 125, result);
  // Patch 12-14 # 126
  constant_a = 4;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 126, result);
  // Patch 12-15 # 127
  constant_a = 5;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 127, result);
  // Patch 12-16 # 128
  constant_a = 6;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 128, result);
  // Patch 12-17 # 129
  constant_a = 7;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 129, result);
  // Patch 12-18 # 130
  constant_a = 8;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 130, result);
  // Patch 12-19 # 131
  constant_a = 9;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 131, result);
  // Patch 12-20 # 132
  constant_a = 10;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 132, result);
  // Patch 13-0 # 133
  constant_a = -10;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 133, result);
  // Patch 13-1 # 134
  constant_a = -9;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 134, result);
  // Patch 13-2 # 135
  constant_a = -8;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 135, result);
  // Patch 13-3 # 136
  constant_a = -7;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 136, result);
  // Patch 13-4 # 137
  constant_a = -6;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 137, result);
  // Patch 13-5 # 138
  constant_a = -5;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 138, result);
  // Patch 13-6 # 139
  constant_a = -4;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 139, result);
  // Patch 13-7 # 140
  constant_a = -3;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 140, result);
  // Patch 13-8 # 141
  constant_a = -2;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 141, result);
  // Patch 13-9 # 142
  constant_a = -1;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 142, result);
  // Patch 13-10 # 143
  constant_a = 0;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 143, result);
  // Patch 13-11 # 144
  constant_a = 1;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 144, result);
  // Patch 13-12 # 145
  constant_a = 2;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 145, result);
  // Patch 13-13 # 146
  constant_a = 3;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 146, result);
  // Patch 13-14 # 147
  constant_a = 4;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 147, result);
  // Patch 13-15 # 148
  constant_a = 5;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 148, result);
  // Patch 13-16 # 149
  constant_a = 6;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 149, result);
  // Patch 13-17 # 150
  constant_a = 7;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 150, result);
  // Patch 13-18 # 151
  constant_a = 8;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 151, result);
  // Patch 13-19 # 152
  constant_a = 9;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 152, result);
  // Patch 13-20 # 153
  constant_a = 10;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 153, result);
  // Patch 14-0 # 154
  constant_a = -10;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 154, result);
  // Patch 14-1 # 155
  constant_a = -9;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 155, result);
  // Patch 14-2 # 156
  constant_a = -8;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 156, result);
  // Patch 14-3 # 157
  constant_a = -7;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 157, result);
  // Patch 14-4 # 158
  constant_a = -6;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 158, result);
  // Patch 14-5 # 159
  constant_a = -5;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 159, result);
  // Patch 14-6 # 160
  constant_a = -4;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 160, result);
  // Patch 14-7 # 161
  constant_a = -3;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 161, result);
  // Patch 14-8 # 162
  constant_a = -2;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 162, result);
  // Patch 14-9 # 163
  constant_a = -1;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 163, result);
  // Patch 14-10 # 164
  constant_a = 0;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 164, result);
  // Patch 14-11 # 165
  constant_a = 1;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 165, result);
  // Patch 14-12 # 166
  constant_a = 2;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 166, result);
  // Patch 14-13 # 167
  constant_a = 3;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 167, result);
  // Patch 14-14 # 168
  constant_a = 4;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 168, result);
  // Patch 14-15 # 169
  constant_a = 5;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 169, result);
  // Patch 14-16 # 170
  constant_a = 6;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 170, result);
  // Patch 14-17 # 171
  constant_a = 7;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 171, result);
  // Patch 14-18 # 172
  constant_a = 8;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 172, result);
  // Patch 14-19 # 173
  constant_a = 9;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 173, result);
  // Patch 14-20 # 174
  constant_a = 10;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 174, result);
  // Patch 15-0 # 175
  result = (y <= x);
  uni_klee_add_patch(patch_results, 175, result);
  // Patch 16-0 # 176
  constant_a = -10;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 176, result);
  // Patch 16-1 # 177
  constant_a = -9;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 177, result);
  // Patch 16-2 # 178
  constant_a = -8;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 178, result);
  // Patch 16-3 # 179
  constant_a = -7;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 179, result);
  // Patch 16-4 # 180
  constant_a = -6;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 180, result);
  // Patch 16-5 # 181
  constant_a = -5;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 181, result);
  // Patch 16-6 # 182
  constant_a = -4;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 182, result);
  // Patch 16-7 # 183
  constant_a = -3;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 183, result);
  // Patch 16-8 # 184
  constant_a = -2;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 184, result);
  // Patch 16-9 # 185
  constant_a = -1;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 185, result);
  // Patch 16-10 # 186
  constant_a = 0;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 186, result);
  // Patch 16-11 # 187
  constant_a = 1;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 187, result);
  // Patch 16-12 # 188
  constant_a = 2;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 188, result);
  // Patch 16-13 # 189
  constant_a = 3;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 189, result);
  // Patch 16-14 # 190
  constant_a = 4;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 190, result);
  // Patch 16-15 # 191
  constant_a = 5;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 191, result);
  // Patch 16-16 # 192
  constant_a = 6;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 192, result);
  // Patch 16-17 # 193
  constant_a = 7;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 193, result);
  // Patch 16-18 # 194
  constant_a = 8;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 194, result);
  // Patch 16-19 # 195
  constant_a = 9;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 195, result);
  // Patch 16-20 # 196
  constant_a = 10;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 196, result);
  // Patch 17-0 # 197
  result = (x <= y);
  uni_klee_add_patch(patch_results, 197, result);
  // Patch 18-0 # 198
  constant_a = -10;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 198, result);
  // Patch 18-1 # 199
  constant_a = -9;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 199, result);
  // Patch 18-2 # 200
  constant_a = -8;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 200, result);
  // Patch 18-3 # 201
  constant_a = -7;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 201, result);
  // Patch 18-4 # 202
  constant_a = -6;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 202, result);
  // Patch 18-5 # 203
  constant_a = -5;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 203, result);
  // Patch 18-6 # 204
  constant_a = -4;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 204, result);
  // Patch 18-7 # 205
  constant_a = -3;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 205, result);
  // Patch 18-8 # 206
  constant_a = -2;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 206, result);
  // Patch 18-9 # 207
  constant_a = -1;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 207, result);
  // Patch 18-10 # 208
  constant_a = 0;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 208, result);
  // Patch 18-11 # 209
  constant_a = 1;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 209, result);
  // Patch 18-12 # 210
  constant_a = 2;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 210, result);
  // Patch 18-13 # 211
  constant_a = 3;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 211, result);
  // Patch 18-14 # 212
  constant_a = 4;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 212, result);
  // Patch 18-15 # 213
  constant_a = 5;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 213, result);
  // Patch 18-16 # 214
  constant_a = 6;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 214, result);
  // Patch 18-17 # 215
  constant_a = 7;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 215, result);
  // Patch 18-18 # 216
  constant_a = 8;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 216, result);
  // Patch 18-19 # 217
  constant_a = 9;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 217, result);
  // Patch 18-20 # 218
  constant_a = 10;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 218, result);
  // Patch 19-0 # 219
  constant_a = -10;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 219, result);
  // Patch 19-1 # 220
  constant_a = -9;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 220, result);
  // Patch 19-2 # 221
  constant_a = -8;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 221, result);
  // Patch 19-3 # 222
  constant_a = -7;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 222, result);
  // Patch 19-4 # 223
  constant_a = -6;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 223, result);
  // Patch 19-5 # 224
  constant_a = -5;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 224, result);
  // Patch 19-6 # 225
  constant_a = -4;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 225, result);
  // Patch 19-7 # 226
  constant_a = -3;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 226, result);
  // Patch 19-8 # 227
  constant_a = -2;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 227, result);
  // Patch 19-9 # 228
  constant_a = -1;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 228, result);
  // Patch 19-10 # 229
  constant_a = 0;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 229, result);
  // Patch 19-11 # 230
  constant_a = 1;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 230, result);
  // Patch 19-12 # 231
  constant_a = 2;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 231, result);
  // Patch 19-13 # 232
  constant_a = 3;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 232, result);
  // Patch 19-14 # 233
  constant_a = 4;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 233, result);
  // Patch 19-15 # 234
  constant_a = 5;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 234, result);
  // Patch 19-16 # 235
  constant_a = 6;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 235, result);
  // Patch 19-17 # 236
  constant_a = 7;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 236, result);
  // Patch 19-18 # 237
  constant_a = 8;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 237, result);
  // Patch 19-19 # 238
  constant_a = 9;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 238, result);
  // Patch 19-20 # 239
  constant_a = 10;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 239, result);
  // Patch 20-0 # 240
  constant_a = -10;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 240, result);
  // Patch 20-1 # 241
  constant_a = -9;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 241, result);
  // Patch 20-2 # 242
  constant_a = -8;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 242, result);
  // Patch 20-3 # 243
  constant_a = -7;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 243, result);
  // Patch 20-4 # 244
  constant_a = -6;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 244, result);
  // Patch 20-5 # 245
  constant_a = -5;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 245, result);
  // Patch 20-6 # 246
  constant_a = -4;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 246, result);
  // Patch 20-7 # 247
  constant_a = -3;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 247, result);
  // Patch 20-8 # 248
  constant_a = -2;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 248, result);
  // Patch 20-9 # 249
  constant_a = -1;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 249, result);
  // Patch 20-10 # 250
  constant_a = 0;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 250, result);
  // Patch 20-11 # 251
  constant_a = 1;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 251, result);
  // Patch 20-12 # 252
  constant_a = 2;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 252, result);
  // Patch 20-13 # 253
  constant_a = 3;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 253, result);
  // Patch 20-14 # 254
  constant_a = 4;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 254, result);
  // Patch 20-15 # 255
  constant_a = 5;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 255, result);
  // Patch 20-16 # 256
  constant_a = 6;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 256, result);
  // Patch 20-17 # 257
  constant_a = 7;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 257, result);
  // Patch 20-18 # 258
  constant_a = 8;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 258, result);
  // Patch 20-19 # 259
  constant_a = 9;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 259, result);
  // Patch 20-20 # 260
  constant_a = 10;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 260, result);
  // Patch correct # 261
  result = (x < y);
  uni_klee_add_patch(patch_results, 261, result);
  klee_select_patch(&uni_klee_patch_id);
  return uni_klee_choice(patch_results, uni_klee_patch_id);
}
// UNI_KLEE_END


#ifdef HAVE_UNISTD_H
# include <unistd.h>
#endif

#ifdef NEED_LIBPORT
# include "libport.h"
#endif

#include "tiffio.h"

#ifndef HAVE_GETOPT
extern int getopt(int, char**, char*);
#endif

#define	streq(a,b)	(strcmp(a,b) == 0)

#ifndef TIFFhowmany8
# define TIFFhowmany8(x) (((x)&0x07)?((uint32)(x)>>3)+1:(uint32)(x)>>3)
#endif

typedef enum {
    EXP50,
    EXP60,
    EXP70,
    EXP80,
    EXP90,
    EXP,
    LINEAR
} Contrast;

static	uint32 tnw = 216;		/* thumbnail width */
static	uint32 tnh = 274;		/* thumbnail height */
static	Contrast contrast = LINEAR;	/* current contrast */
static	uint8* thumbnail;

static	int cpIFD(TIFF*, TIFF*);
static	int generateThumbnail(TIFF*, TIFF*);
static	void initScale();
static	void usage(void);

extern	char* optarg;
extern	int optind;

int
main(int argc, char* argv[])
{
    TIFF* in;
    TIFF* out;
    int c;

    while ((c = getopt(argc, argv, "w:h:c:")) != -1) {
	switch (c) {
	case 'w':	tnw = strtoul(optarg, NULL, 0); break;
	case 'h':	tnh = strtoul(optarg, NULL, 0); break;
	case 'c':	contrast = streq(optarg, "exp50") ? EXP50 :
				   streq(optarg, "exp60") ? EXP60 :
				   streq(optarg, "exp70") ? EXP70 :
				   streq(optarg, "exp80") ? EXP80 :
				   streq(optarg, "exp90") ? EXP90 :
				   streq(optarg, "exp")   ? EXP :
				   streq(optarg, "linear")? LINEAR :
							    EXP;
			break;
	default:	usage();
	}
    }
    if (argc-optind != 2)
	usage();

    out = TIFFOpen(argv[optind+1], "w");
    if (out == NULL)
	return 2;
    in = TIFFOpen(argv[optind], "r");
    if( in == NULL )
        return 2;

    thumbnail = (uint8*) _TIFFmalloc(tnw * tnh);
    if (!thumbnail) {
	    TIFFError(TIFFFileName(in),
		      "Can't allocate space for thumbnail buffer.");
	    return 1;
    }

    if (in != NULL) {
	initScale();
	do {
	    if (!generateThumbnail(in, out))
		goto bad;
	    if (!cpIFD(in, out) || !TIFFWriteDirectory(out))
		goto bad;
	} while (TIFFReadDirectory(in));
	(void) TIFFClose(in);
    }
    (void) TIFFClose(out);
    return 0;
bad:
    (void) TIFFClose(out);
    return 1;
}

#define	CopyField(tag, v) \
    if (TIFFGetField(in, tag, &v)) TIFFSetField(out, tag, v)
#define	CopyField2(tag, v1, v2) \
    if (TIFFGetField(in, tag, &v1, &v2)) TIFFSetField(out, tag, v1, v2)
#define	CopyField3(tag, v1, v2, v3) \
    if (TIFFGetField(in, tag, &v1, &v2, &v3)) TIFFSetField(out, tag, v1, v2, v3)
#define	CopyField4(tag, v1, v2, v3, v4) \
    if (TIFFGetField(in, tag, &v1, &v2, &v3, &v4)) TIFFSetField(out, tag, v1, v2, v3, v4)

static void
cpTag(TIFF* in, TIFF* out, uint16 tag, uint16 count, TIFFDataType type)
{
	switch (type) {
	case TIFF_SHORT:
		if (count == 1) {
			uint16 shortv;
			CopyField(tag, shortv);
		} else if (count == 2) {
			uint16 shortv1, shortv2;
			CopyField2(tag, shortv1, shortv2);
		} else if (count == 4) {
			uint16 *tr, *tg, *tb, *ta;
			CopyField4(tag, tr, tg, tb, ta);
		} else if (count == (uint16) -1) {
			uint16 shortv1;
			uint16* shortav;
			CopyField2(tag, shortv1, shortav);
		}
		break;
	case TIFF_LONG:
		{ uint32 longv;
		  CopyField(tag, longv);
		}
		break;
	case TIFF_LONG8:
		{ uint64 longv8;
		  CopyField(tag, longv8);
		}
		break;
	case TIFF_SLONG8:
		{ int64 longv8;
		  CopyField(tag, longv8);
		}
		break;
	case TIFF_RATIONAL:
		if (count == 1) {
			float floatv;
			CopyField(tag, floatv);
		} else if (count == (uint16) -1) {
			float* floatav;
			CopyField(tag, floatav);
		}
		break;
	case TIFF_ASCII:
		{ char* stringv;
		  CopyField(tag, stringv);
		}
		break;
	case TIFF_DOUBLE:
		if (count == 1) {
			double doublev;
			CopyField(tag, doublev);
		} else if (count == (uint16) -1) {
			double* doubleav;
			CopyField(tag, doubleav);
		}
		break;
	case TIFF_IFD8:
		{ toff_t ifd8;
		  CopyField(tag, ifd8);
		}
		break;          default:
                TIFFError(TIFFFileName(in),
                          "Data type %d is not supported, tag %d skipped.",
                          tag, type);
	}
}

#undef CopyField4
#undef CopyField3
#undef CopyField2
#undef CopyField

static struct cpTag {
    uint16	tag;
    uint16	count;
    TIFFDataType type;
} tags[] = {
    { TIFFTAG_IMAGEWIDTH,		1, TIFF_LONG },
    { TIFFTAG_IMAGELENGTH,		1, TIFF_LONG },
    { TIFFTAG_BITSPERSAMPLE,		1, TIFF_SHORT },
    { TIFFTAG_COMPRESSION,		1, TIFF_SHORT },
    { TIFFTAG_FILLORDER,		1, TIFF_SHORT },
    { TIFFTAG_SAMPLESPERPIXEL,		1, TIFF_SHORT },
    { TIFFTAG_ROWSPERSTRIP,		1, TIFF_LONG },
    { TIFFTAG_PLANARCONFIG,		1, TIFF_SHORT },
    { TIFFTAG_GROUP3OPTIONS,		1, TIFF_LONG },
    { TIFFTAG_SUBFILETYPE,		1, TIFF_LONG },
    { TIFFTAG_PHOTOMETRIC,		1, TIFF_SHORT },
    { TIFFTAG_THRESHHOLDING,		1, TIFF_SHORT },
    { TIFFTAG_DOCUMENTNAME,		1, TIFF_ASCII },
    { TIFFTAG_IMAGEDESCRIPTION,		1, TIFF_ASCII },
    { TIFFTAG_MAKE,			1, TIFF_ASCII },
    { TIFFTAG_MODEL,			1, TIFF_ASCII },
    { TIFFTAG_ORIENTATION,		1, TIFF_SHORT },
    { TIFFTAG_MINSAMPLEVALUE,		1, TIFF_SHORT },
    { TIFFTAG_MAXSAMPLEVALUE,		1, TIFF_SHORT },
    { TIFFTAG_XRESOLUTION,		1, TIFF_RATIONAL },
    { TIFFTAG_YRESOLUTION,		1, TIFF_RATIONAL },
    { TIFFTAG_PAGENAME,			1, TIFF_ASCII },
    { TIFFTAG_XPOSITION,		1, TIFF_RATIONAL },
    { TIFFTAG_YPOSITION,		1, TIFF_RATIONAL },
    { TIFFTAG_GROUP4OPTIONS,		1, TIFF_LONG },
    { TIFFTAG_RESOLUTIONUNIT,		1, TIFF_SHORT },
    { TIFFTAG_PAGENUMBER,		2, TIFF_SHORT },
    { TIFFTAG_SOFTWARE,			1, TIFF_ASCII },
    { TIFFTAG_DATETIME,			1, TIFF_ASCII },
    { TIFFTAG_ARTIST,			1, TIFF_ASCII },
    { TIFFTAG_HOSTCOMPUTER,		1, TIFF_ASCII },
    { TIFFTAG_WHITEPOINT,		2, TIFF_RATIONAL },
    { TIFFTAG_PRIMARYCHROMATICITIES,	(uint16) -1,TIFF_RATIONAL },
    { TIFFTAG_HALFTONEHINTS,		2, TIFF_SHORT },
    { TIFFTAG_BADFAXLINES,		1, TIFF_LONG },
    { TIFFTAG_CLEANFAXDATA,		1, TIFF_SHORT },
    { TIFFTAG_CONSECUTIVEBADFAXLINES,	1, TIFF_LONG },
    { TIFFTAG_INKSET,			1, TIFF_SHORT },
    { TIFFTAG_INKNAMES,			1, TIFF_ASCII },
    { TIFFTAG_DOTRANGE,			2, TIFF_SHORT },
    { TIFFTAG_TARGETPRINTER,		1, TIFF_ASCII },
    { TIFFTAG_SAMPLEFORMAT,		1, TIFF_SHORT },
    { TIFFTAG_YCBCRCOEFFICIENTS,	(uint16) -1,TIFF_RATIONAL },
    { TIFFTAG_YCBCRSUBSAMPLING,		2, TIFF_SHORT },
    { TIFFTAG_YCBCRPOSITIONING,		1, TIFF_SHORT },
    { TIFFTAG_REFERENCEBLACKWHITE,	(uint16) -1,TIFF_RATIONAL },
    { TIFFTAG_EXTRASAMPLES,		(uint16) -1, TIFF_SHORT },
};
#define	NTAGS	(sizeof (tags) / sizeof (tags[0]))

static void
cpTags(TIFF* in, TIFF* out)
{
    struct cpTag *p;
    for (p = tags; p < &tags[NTAGS]; p++)
	{
		/* Horrible: but TIFFGetField() expects 2 arguments to be passed */
		/* if we request a tag that is defined in a codec, but that codec */
		/* isn't used */
		if( p->tag == TIFFTAG_GROUP3OPTIONS )
		{
			uint16 compression;
			if( !TIFFGetField(in, TIFFTAG_COMPRESSION, &compression) ||
				compression != COMPRESSION_CCITTFAX3 )
				continue;
		}
		if( p->tag == TIFFTAG_GROUP4OPTIONS )
		{
			uint16 compression;
			if( !TIFFGetField(in, TIFFTAG_COMPRESSION, &compression) ||
				compression != COMPRESSION_CCITTFAX4 )
				continue;
		}
		cpTag(in, out, p->tag, p->count, p->type);
	}
}
#undef NTAGS

static int
cpStrips(TIFF* in, TIFF* out)
{
    tsize_t bufsize  = TIFFStripSize(in);
    unsigned char *buf = (unsigned char *)_TIFFmalloc(bufsize);

    if (buf) {
	tstrip_t s, ns = TIFFNumberOfStrips(in);
	uint64 *bytecounts;

	TIFFGetField(in, TIFFTAG_STRIPBYTECOUNTS, &bytecounts);
	for (s = 0; s < ns; s++) {
	  if (bytecounts[s] > (uint64) bufsize) {
		buf = (unsigned char *)_TIFFrealloc(buf, (tmsize_t)bytecounts[s]);
		if (!buf)
		    goto bad;
		bufsize = (tmsize_t)bytecounts[s];
	    }
	    if (TIFFReadRawStrip(in, s, buf, (tmsize_t)bytecounts[s]) < 0 ||
		TIFFWriteRawStrip(out, s, buf, (tmsize_t)bytecounts[s]) < 0) {
		_TIFFfree(buf);
		return 0;
	    }
	}
	_TIFFfree(buf);
	return 1;
    }

bad:
	TIFFError(TIFFFileName(in),
		  "Can't allocate space for strip buffer.");
	return 0;
}

static int
cpTiles(TIFF* in, TIFF* out)
{
    tsize_t bufsize = TIFFTileSize(in);
    unsigned char *buf = (unsigned char *)_TIFFmalloc(bufsize);

    if (buf) {
	ttile_t t, nt = TIFFNumberOfTiles(in);
	uint64 *bytecounts;

	TIFFGetField(in, TIFFTAG_TILEBYTECOUNTS, &bytecounts);
	for (t = 0; t < nt; t++) {
	    if (bytecounts[t] > (uint64) bufsize) {
		buf = (unsigned char *)_TIFFrealloc(buf, (tmsize_t)bytecounts[t]);
		if (!buf)
		    goto bad;
		bufsize = (tmsize_t)bytecounts[t];
	    }
	    if (TIFFReadRawTile(in, t, buf, (tmsize_t)bytecounts[t]) < 0 ||
		TIFFWriteRawTile(out, t, buf, (tmsize_t)bytecounts[t]) < 0) {
		_TIFFfree(buf);
		return 0;
	    }
	}
	_TIFFfree(buf);
	return 1;
    }

bad:
    TIFFError(TIFFFileName(in),
		  "Can't allocate space for tile buffer.");
	return (0);
}

static int
cpIFD(TIFF* in, TIFF* out)
{
    cpTags(in, out);
    if (TIFFIsTiled(in)) {
	if (!cpTiles(in, out))
	    return (0);
    } else {
	if (!cpStrips(in, out))
	    return (0);
    }
    return (1);
}

static	uint16	photometric;		/* current photometric of raster */
static	uint16	filterWidth;		/* filter width in pixels */
static	uint32	stepSrcWidth;		/* src image stepping width */
static	uint32	stepDstWidth;		/* dest stepping width */
static	uint8* src0;			/* horizontal bit stepping (start) */
static	uint8* src1;			/* horizontal bit stepping (middle) */
static	uint8* src2;			/* horizontal bit stepping (end) */
static	uint32* rowoff;			/* row offset for stepping */
static	uint8 cmap[256];		/* colormap indexes */
static	uint8 bits[256];		/* count of bits set */

static void
setupBitsTables()
{
    int i;
    for (i = 0; i < 256; i++) {
	int n = 0;
	if (i&0x01) n++;
	if (i&0x02) n++;
	if (i&0x04) n++;
	if (i&0x08) n++;
	if (i&0x10) n++;
	if (i&0x20) n++;
	if (i&0x40) n++;
	if (i&0x80) n++;
	bits[i] = n;
    }
}

static int clamp(float v, int low, int high)
    { return (v < low ? low : v > high ? high : (int)v); }

#ifndef M_E
#define M_E		2.7182818284590452354
#endif

static void
expFill(float pct[], uint32 p, uint32 n)
{
    uint32 i;
    uint32 c = (p * n) / 100;
    for (i = 1; i < c; i++)
	pct[i] = (float) (1-exp(i/((double)(n-1)))/ M_E);
    for (; i < n; i++)
	pct[i] = 0.;
}

static void
setupCmap()
{
    float pct[256];			/* known to be large enough */
    uint32 i;
    pct[0] = 1;				/* force white */
    switch (contrast) {
    case EXP50: expFill(pct, 50, 256); break;
    case EXP60:	expFill(pct, 60, 256); break;
    case EXP70:	expFill(pct, 70, 256); break;
    case EXP80:	expFill(pct, 80, 256); break;
    case EXP90:	expFill(pct, 90, 256); break;
    case EXP:	expFill(pct, 100, 256); break;
    case LINEAR:
	for (i = 1; i < 256; i++)
	    pct[i] = 1-((float)i)/(256-1);
	break;
    }
    switch (photometric) {
    case PHOTOMETRIC_MINISWHITE:
	for (i = 0; i < 256; i++)
	    cmap[i] = clamp(255*pct[(256-1)-i], 0, 255);
	break;
    case PHOTOMETRIC_MINISBLACK:
	for (i = 0; i < 256; i++)
	    cmap[i] = clamp(255*pct[i], 0, 255);
	break;
    }
}

static void
initScale()
{
    src0 = (uint8*) _TIFFmalloc(sizeof (uint8) * tnw);
    src1 = (uint8*) _TIFFmalloc(sizeof (uint8) * tnw);
    src2 = (uint8*) _TIFFmalloc(sizeof (uint8) * tnw);
    rowoff = (uint32*) _TIFFmalloc(sizeof (uint32) * tnw);
    filterWidth = 0;
    stepDstWidth = stepSrcWidth = 0;
    setupBitsTables();
}

/*
 * Calculate the horizontal accumulation parameteres
 * according to the widths of the src and dst images.
 */
static void
setupStepTables(uint32 sw)
{
    if (stepSrcWidth != sw || stepDstWidth != tnw) {
	int step = sw;
	int limit = tnw;
	int err = 0;
	uint32 sx = 0;
	uint32 x;
	int fw;
	uint8 b;
	for (x = 0; x < tnw; x++) {
	    uint32 sx0 = sx;
	    err += step;
	    while (err >= limit) {
		err -= limit;
		sx++;
	    }
	    rowoff[x] = sx0 >> 3;
	    fw = sx - sx0;		/* width */
	    b = (fw < 8) ? 0xff<<(8-fw) : 0xff;
	    src0[x] = b >> (sx0&7);
	    fw -= 8 - (sx0&7);
	    if (fw < 0)
		fw = 0;
	    src1[x] = fw >> 3;
	    fw -= (fw>>3)<<3;
	    src2[x] = 0xff << (8-fw);
	}
	stepSrcWidth = sw;
	stepDstWidth = tnw;
    }
}

static void
setrow(uint8* row, uint32 nrows, const uint8* rows[])
{
    uint32 x;
    uint32 area = nrows * filterWidth;
    for (x = 0; x < tnw; x++) {
	uint32 mask0 = src0[x];
	uint32 fw = src1[x];
	uint32 mask1 = src1[x];
	uint32 off = rowoff[x];
	uint32 acc = 0;
	uint32 y, i;
	for (y = 0; y < nrows; y++) {
	    const uint8* src = rows[y] + off;
	    acc += bits[*src++ & mask0];
	    switch (fw) {
	    default:
		for (i = fw; i > 8; i--)
		    acc += bits[*src++];
		/* fall thru... */
	    case 8: acc += bits[*src++];
	    case 7: acc += bits[*src++];
	    case 6: acc += bits[*src++];
	    case 5: acc += bits[*src++];
	    case 4: acc += bits[*src++];
	    case 3: acc += bits[*src++];
	    case 2: acc += bits[*src++];
	    case 1: acc += bits[*src++];
	    case 0: break;
	    }
	    acc += bits[*src & mask1];
	}
	*row++ = cmap[(255*acc)/area];
    }
}

/*
 * Install the specified image.  The
 * image is resized to fit the display page using
 * a box filter.  The resultant pixels are mapped
 * with a user-selectable contrast curve.
 */
static void
setImage1(const uint8* br, uint32 rw, uint32 rh)
{
    int step = rh;
    int limit = tnh;
    int err = 0;
    int bpr = TIFFhowmany8(rw);
    int sy = 0;
    uint8* row = thumbnail;
    uint32 dy;
    for (dy = 0; dy < tnh; dy++) {
	const uint8* rows[256];
	uint32 nrows = 1;
	fprintf(stderr, "bpr=%d, sy=%d, bpr*sy=%d\n", bpr, sy, bpr*sy);
	rows[0] = br + bpr*sy;
	err += step;
while (err >= limit && __cpr_choice("L65", "bool", (long long[]){nrows, 256}, (char*[]){"x", "y"}, 2, (int*[]){}, (char*[]){}, 0)) {

	    err -= limit;
	    sy++;
	    if (err >= limit)
		rows[nrows++] = br + bpr*sy;
	}
	setrow(row, nrows, rows);
	row += tnw;
    }
}

static void
setImage(const uint8* br, uint32 rw, uint32 rh)
{
    filterWidth = (uint16) ceil((double) rw / (double) tnw);
    setupStepTables(rw);
    setImage1(br, rw, rh);
}

static int
generateThumbnail(TIFF* in, TIFF* out)
{
    unsigned char* raster;
    unsigned char* rp;
    uint32 sw, sh, rps;
    uint16 bps, spp;
    tsize_t rowsize, rastersize;
    tstrip_t s, ns = TIFFNumberOfStrips(in);
    toff_t diroff[1];

    TIFFGetField(in, TIFFTAG_IMAGEWIDTH, &sw);
    TIFFGetField(in, TIFFTAG_IMAGELENGTH, &sh);
    TIFFGetFieldDefaulted(in, TIFFTAG_BITSPERSAMPLE, &bps);
    TIFFGetFieldDefaulted(in, TIFFTAG_SAMPLESPERPIXEL, &spp);
    TIFFGetFieldDefaulted(in, TIFFTAG_ROWSPERSTRIP, &rps);
    if (spp != 1 || bps != 1)
	return 0;
    rowsize = TIFFScanlineSize(in);
    rastersize = sh * rowsize;
    fprintf(stderr, "rastersize=%u\n", (unsigned int)rastersize);
	/* +3 : add a few guard bytes since setrow() can read a bit */
	/* outside buffer */
    raster = (unsigned char*)_TIFFmalloc(rastersize+3);
    if (!raster) {
	    TIFFError(TIFFFileName(in),
		      "Can't allocate space for raster buffer.");
	    return 0;
    }
    raster[rastersize] = 0;
    raster[rastersize+1] = 0;
    raster[rastersize+2] = 0;
    rp = raster;
    for (s = 0; s < ns; s++) {
	(void) TIFFReadEncodedStrip(in, s, rp, -1);
	rp += rps * rowsize;
    }
    TIFFGetField(in, TIFFTAG_PHOTOMETRIC, &photometric);
    setupCmap();
    setImage(raster, sw, sh);
    _TIFFfree(raster);

    TIFFSetField(out, TIFFTAG_SUBFILETYPE, FILETYPE_REDUCEDIMAGE);
    TIFFSetField(out, TIFFTAG_IMAGEWIDTH, (uint32) tnw);
    TIFFSetField(out, TIFFTAG_IMAGELENGTH, (uint32) tnh);
    TIFFSetField(out, TIFFTAG_BITSPERSAMPLE, (uint16) 8);
    TIFFSetField(out, TIFFTAG_SAMPLESPERPIXEL, (uint16) 1);
    TIFFSetField(out, TIFFTAG_COMPRESSION, COMPRESSION_PACKBITS);
    TIFFSetField(out, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_MINISWHITE);
    TIFFSetField(out, TIFFTAG_PLANARCONFIG, PLANARCONFIG_CONTIG);
    TIFFSetField(out, TIFFTAG_ORIENTATION, ORIENTATION_TOPLEFT);
    cpTag(in, out, TIFFTAG_SOFTWARE,		(uint16) -1, TIFF_ASCII);
    cpTag(in, out, TIFFTAG_IMAGEDESCRIPTION,	(uint16) -1, TIFF_ASCII);
    cpTag(in, out, TIFFTAG_DATETIME,		(uint16) -1, TIFF_ASCII);
    cpTag(in, out, TIFFTAG_HOSTCOMPUTER,	(uint16) -1, TIFF_ASCII);
    diroff[0] = 0UL;
    TIFFSetField(out, TIFFTAG_SUBIFD, 1, diroff);
    return (TIFFWriteEncodedStrip(out, 0, thumbnail, tnw*tnh) != -1 &&
            TIFFWriteDirectory(out) != -1);
}

char* stuff[] = {
"usage: thumbnail [options] input.tif output.tif",
"where options are:",
" -h #		specify thumbnail image height (default is 274)",
" -w #		specify thumbnail image width (default is 216)",
"",
" -c linear	use linear contrast curve",
" -c exp50	use 50% exponential contrast curve",
" -c exp60	use 60% exponential contrast curve",
" -c exp70	use 70% exponential contrast curve",
" -c exp80	use 80% exponential contrast curve",
" -c exp90	use 90% exponential contrast curve",
" -c exp		use pure exponential contrast curve",
NULL
};

static void
usage(void)
{
	char buf[BUFSIZ];
	int i;

	setbuf(stderr, buf);
        fprintf(stderr, "%s\n\n", TIFFGetVersion());
	for (i = 0; stuff[i] != NULL; i++)
		fprintf(stderr, "%s\n", stuff[i]);
	exit(-1);
}

/* vim: set ts=8 sts=8 sw=8 noet: */
/*
 * Local Variables:
 * mode: c
 * c-basic-offset: 8
 * fill-column: 78
 * End:
 */
