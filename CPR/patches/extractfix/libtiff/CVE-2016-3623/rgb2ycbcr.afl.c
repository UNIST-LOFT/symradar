/* $Id$ */

/*
 * Copyright (c) 1991-1997 Sam Leffler
 * Copyright (c) 1991-1997 Silicon Graphics, Inc.
 *
 * Permission to use, copy, modify, distribute, and sell this software and 
 * its documentation for any purpose is hereby granted without fee, provided
 * that (i) the above copyright notices and this permission notice appear in
 * all copies of the software and related documentation, and (ii) the names of
 * Sam Leffler and Silicon Graphics may not be used in any advertising or
 * publicity relating to the software without the specific, prior written
 * permission of Sam Leffler and Silicon Graphics.
 * 
 * THE SOFTWARE IS PROVIDED "AS-IS" AND WITHOUT WARRANTY OF ANY KIND, 
 * EXPRESS, IMPLIED OR OTHERWISE, INCLUDING WITHOUT LIMITATION, ANY 
 * WARRANTY OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.  
 * 
 * IN NO EVENT SHALL SAM LEFFLER OR SILICON GRAPHICS BE LIABLE FOR
 * ANY SPECIAL, INCIDENTAL, INDIRECT OR CONSEQUENTIAL DAMAGES OF ANY KIND,
 * OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS,
 * WHETHER OR NOT ADVISED OF THE POSSIBILITY OF DAMAGE, AND ON ANY THEORY OF 
 * LIABILITY, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE 
 * OF THIS SOFTWARE.
 */

#include "tif_config.h"

#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#ifdef HAVE_UNISTD_H
# include <unistd.h>
#endif

#ifdef NEED_LIBPORT
# include "libport.h"
#endif

#include "tiffiop.h"
#include "tiffio.h"


int uni_klee_patch_id;

void klee_select_patch(int *patch_id) {
  *patch_id = atoi(getenv("DAFL_PATCH_ID"));
}

void uni_klee_add_patch(int *patch_results, int patch_id, int result) {
  patch_results[patch_id] = result;
}

int uni_klee_choice(int *patch_results, int patch_id) {
//   FILE *fp=fopen(getenv("DAFL_RESULT_FILE"),"a");
//   if (fp == NULL) {
//     fprintf(stderr, "Error opening file!\n");
//     exit(1);
//   }
//   fprintf(fp, "%d ", patch_results[patch_id]);
//   fclose(fp);
  return patch_results[patch_id];
}

// UNI_KLEE_START
int __cpr_choice(char* lid, char* typestr,
                     long long* rvals, char** rvals_ids, int rvals_size,
                     int** lvals, char** lvals_ids, int lvals_size){
  // int patch_results[4096];
  int result;
  long long x = rvals[0];
  long long y = rvals[1];
  long long constant_a;
  int patch_results[258];
  // Patch buggy # 0
  result = (0);
  uni_klee_add_patch(patch_results, 0, result);
  // Patch 1-0 # 1
  result = (x == x);
  uni_klee_add_patch(patch_results, 1, result);
  // Patch 2-0 # 2
  constant_a = -10;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 2, result);
  // Patch 2-1 # 3
  constant_a = -9;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 3, result);
  // Patch 2-2 # 4
  constant_a = -8;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 4, result);
  // Patch 2-3 # 5
  constant_a = -7;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 5, result);
  // Patch 2-4 # 6
  constant_a = -6;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 6, result);
  // Patch 2-5 # 7
  constant_a = -5;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 7, result);
  // Patch 2-6 # 8
  constant_a = -4;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 8, result);
  // Patch 2-7 # 9
  constant_a = -3;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 9, result);
  // Patch 2-8 # 10
  constant_a = -2;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 10, result);
  // Patch 2-9 # 11
  constant_a = -1;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 11, result);
  // Patch 2-10 # 12
  constant_a = 0;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 12, result);
  // Patch 2-11 # 13
  constant_a = 1;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 13, result);
  // Patch 2-12 # 14
  constant_a = 2;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 14, result);
  // Patch 2-13 # 15
  constant_a = 3;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 15, result);
  // Patch 2-14 # 16
  constant_a = 4;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 16, result);
  // Patch 2-15 # 17
  constant_a = 5;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 17, result);
  // Patch 2-16 # 18
  constant_a = 6;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 18, result);
  // Patch 2-17 # 19
  constant_a = 7;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 19, result);
  // Patch 2-18 # 20
  constant_a = 8;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 20, result);
  // Patch 2-19 # 21
  constant_a = 9;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 21, result);
  // Patch 2-20 # 22
  constant_a = 10;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 22, result);
  // Patch 3-0 # 23
  constant_a = -10;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 23, result);
  // Patch 3-1 # 24
  constant_a = -9;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 24, result);
  // Patch 3-2 # 25
  constant_a = -8;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 25, result);
  // Patch 3-3 # 26
  constant_a = -7;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 26, result);
  // Patch 3-4 # 27
  constant_a = -6;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 27, result);
  // Patch 3-5 # 28
  constant_a = -5;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 28, result);
  // Patch 3-6 # 29
  constant_a = -4;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 29, result);
  // Patch 3-7 # 30
  constant_a = -3;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 30, result);
  // Patch 3-8 # 31
  constant_a = -2;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 31, result);
  // Patch 3-9 # 32
  constant_a = -1;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 32, result);
  // Patch 3-10 # 33
  constant_a = 0;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 33, result);
  // Patch 3-11 # 34
  constant_a = 1;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 34, result);
  // Patch 3-12 # 35
  constant_a = 2;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 35, result);
  // Patch 3-13 # 36
  constant_a = 3;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 36, result);
  // Patch 3-14 # 37
  constant_a = 4;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 37, result);
  // Patch 3-15 # 38
  constant_a = 5;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 38, result);
  // Patch 3-16 # 39
  constant_a = 6;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 39, result);
  // Patch 3-17 # 40
  constant_a = 7;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 40, result);
  // Patch 3-18 # 41
  constant_a = 8;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 41, result);
  // Patch 3-19 # 42
  constant_a = 9;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 42, result);
  // Patch 3-20 # 43
  constant_a = 10;
  result = (y == constant_a);
  uni_klee_add_patch(patch_results, 43, result);
  // Patch 4-0 # 44
  constant_a = -10;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 44, result);
  // Patch 4-1 # 45
  constant_a = -9;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 45, result);
  // Patch 4-2 # 46
  constant_a = -8;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 46, result);
  // Patch 4-3 # 47
  constant_a = -7;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 47, result);
  // Patch 4-4 # 48
  constant_a = -6;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 48, result);
  // Patch 4-5 # 49
  constant_a = -5;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 49, result);
  // Patch 4-6 # 50
  constant_a = -4;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 50, result);
  // Patch 4-7 # 51
  constant_a = -3;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 51, result);
  // Patch 4-8 # 52
  constant_a = -2;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 52, result);
  // Patch 4-9 # 53
  constant_a = -1;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 53, result);
  // Patch 4-10 # 54
  constant_a = 0;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 54, result);
  // Patch 4-11 # 55
  constant_a = 1;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 55, result);
  // Patch 4-12 # 56
  constant_a = 2;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 56, result);
  // Patch 4-13 # 57
  constant_a = 3;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 57, result);
  // Patch 4-14 # 58
  constant_a = 4;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 58, result);
  // Patch 4-15 # 59
  constant_a = 5;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 59, result);
  // Patch 4-16 # 60
  constant_a = 6;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 60, result);
  // Patch 4-17 # 61
  constant_a = 7;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 61, result);
  // Patch 4-18 # 62
  constant_a = 8;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 62, result);
  // Patch 4-19 # 63
  constant_a = 9;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 63, result);
  // Patch 4-20 # 64
  constant_a = 10;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 64, result);
  // Patch 5-0 # 65
  result = (y != x);
  uni_klee_add_patch(patch_results, 65, result);
  // Patch 6-0 # 66
  constant_a = -10;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 66, result);
  // Patch 6-1 # 67
  constant_a = -9;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 67, result);
  // Patch 6-2 # 68
  constant_a = -8;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 68, result);
  // Patch 6-3 # 69
  constant_a = -7;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 69, result);
  // Patch 6-4 # 70
  constant_a = -6;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 70, result);
  // Patch 6-5 # 71
  constant_a = -5;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 71, result);
  // Patch 6-6 # 72
  constant_a = -4;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 72, result);
  // Patch 6-7 # 73
  constant_a = -3;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 73, result);
  // Patch 6-8 # 74
  constant_a = -2;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 74, result);
  // Patch 6-9 # 75
  constant_a = -1;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 75, result);
  // Patch 6-10 # 76
  constant_a = 0;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 76, result);
  // Patch 6-11 # 77
  constant_a = 1;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 77, result);
  // Patch 6-12 # 78
  constant_a = 2;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 78, result);
  // Patch 6-13 # 79
  constant_a = 3;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 79, result);
  // Patch 6-14 # 80
  constant_a = 4;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 80, result);
  // Patch 6-15 # 81
  constant_a = 5;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 81, result);
  // Patch 6-16 # 82
  constant_a = 6;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 82, result);
  // Patch 6-17 # 83
  constant_a = 7;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 83, result);
  // Patch 6-18 # 84
  constant_a = 8;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 84, result);
  // Patch 6-19 # 85
  constant_a = 9;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 85, result);
  // Patch 6-20 # 86
  constant_a = 10;
  result = (y != constant_a);
  uni_klee_add_patch(patch_results, 86, result);
  // Patch 7-0 # 87
  constant_a = -10;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 87, result);
  // Patch 7-1 # 88
  constant_a = -9;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 88, result);
  // Patch 7-2 # 89
  constant_a = -8;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 89, result);
  // Patch 7-3 # 90
  constant_a = -7;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 90, result);
  // Patch 7-4 # 91
  constant_a = -6;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 91, result);
  // Patch 7-5 # 92
  constant_a = -5;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 92, result);
  // Patch 7-6 # 93
  constant_a = -4;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 93, result);
  // Patch 7-7 # 94
  constant_a = -3;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 94, result);
  // Patch 7-8 # 95
  constant_a = -2;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 95, result);
  // Patch 7-9 # 96
  constant_a = -1;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 96, result);
  // Patch 7-10 # 97
  constant_a = 0;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 97, result);
  // Patch 7-11 # 98
  constant_a = 1;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 98, result);
  // Patch 7-12 # 99
  constant_a = 2;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 99, result);
  // Patch 7-13 # 100
  constant_a = 3;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 100, result);
  // Patch 7-14 # 101
  constant_a = 4;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 101, result);
  // Patch 7-15 # 102
  constant_a = 5;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 102, result);
  // Patch 7-16 # 103
  constant_a = 6;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 103, result);
  // Patch 7-17 # 104
  constant_a = 7;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 104, result);
  // Patch 7-18 # 105
  constant_a = 8;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 105, result);
  // Patch 7-19 # 106
  constant_a = 9;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 106, result);
  // Patch 7-20 # 107
  constant_a = 10;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 107, result);
  // Patch 8-0 # 108
  constant_a = -10;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 108, result);
  // Patch 8-1 # 109
  constant_a = -9;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 109, result);
  // Patch 8-2 # 110
  constant_a = -8;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 110, result);
  // Patch 8-3 # 111
  constant_a = -7;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 111, result);
  // Patch 8-4 # 112
  constant_a = -6;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 112, result);
  // Patch 8-5 # 113
  constant_a = -5;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 113, result);
  // Patch 8-6 # 114
  constant_a = -4;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 114, result);
  // Patch 8-7 # 115
  constant_a = -3;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 115, result);
  // Patch 8-8 # 116
  constant_a = -2;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 116, result);
  // Patch 8-9 # 117
  constant_a = -1;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 117, result);
  // Patch 8-10 # 118
  constant_a = 0;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 118, result);
  // Patch 8-11 # 119
  constant_a = 1;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 119, result);
  // Patch 8-12 # 120
  constant_a = 2;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 120, result);
  // Patch 8-13 # 121
  constant_a = 3;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 121, result);
  // Patch 8-14 # 122
  constant_a = 4;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 122, result);
  // Patch 8-15 # 123
  constant_a = 5;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 123, result);
  // Patch 8-16 # 124
  constant_a = 6;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 124, result);
  // Patch 8-17 # 125
  constant_a = 7;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 125, result);
  // Patch 8-18 # 126
  constant_a = 8;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 126, result);
  // Patch 8-19 # 127
  constant_a = 9;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 127, result);
  // Patch 8-20 # 128
  constant_a = 10;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 128, result);
  // Patch 9-0 # 129
  constant_a = -10;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 129, result);
  // Patch 9-1 # 130
  constant_a = -9;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 130, result);
  // Patch 9-2 # 131
  constant_a = -8;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 131, result);
  // Patch 9-3 # 132
  constant_a = -7;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 132, result);
  // Patch 9-4 # 133
  constant_a = -6;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 133, result);
  // Patch 9-5 # 134
  constant_a = -5;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 134, result);
  // Patch 9-6 # 135
  constant_a = -4;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 135, result);
  // Patch 9-7 # 136
  constant_a = -3;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 136, result);
  // Patch 9-8 # 137
  constant_a = -2;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 137, result);
  // Patch 9-9 # 138
  constant_a = -1;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 138, result);
  // Patch 9-10 # 139
  constant_a = 0;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 139, result);
  // Patch 9-11 # 140
  constant_a = 1;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 140, result);
  // Patch 9-12 # 141
  constant_a = 2;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 141, result);
  // Patch 9-13 # 142
  constant_a = 3;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 142, result);
  // Patch 9-14 # 143
  constant_a = 4;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 143, result);
  // Patch 9-15 # 144
  constant_a = 5;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 144, result);
  // Patch 9-16 # 145
  constant_a = 6;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 145, result);
  // Patch 9-17 # 146
  constant_a = 7;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 146, result);
  // Patch 9-18 # 147
  constant_a = 8;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 147, result);
  // Patch 9-19 # 148
  constant_a = 9;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 148, result);
  // Patch 9-20 # 149
  constant_a = 10;
  result = (y < constant_a);
  uni_klee_add_patch(patch_results, 149, result);
  // Patch 10-0 # 150
  result = (x < y);
  uni_klee_add_patch(patch_results, 150, result);
  // Patch 11-0 # 151
  constant_a = -10;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 151, result);
  // Patch 11-1 # 152
  constant_a = -9;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 152, result);
  // Patch 11-2 # 153
  constant_a = -8;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 153, result);
  // Patch 11-3 # 154
  constant_a = -7;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 154, result);
  // Patch 11-4 # 155
  constant_a = -6;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 155, result);
  // Patch 11-5 # 156
  constant_a = -5;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 156, result);
  // Patch 11-6 # 157
  constant_a = -4;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 157, result);
  // Patch 11-7 # 158
  constant_a = -3;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 158, result);
  // Patch 11-8 # 159
  constant_a = -2;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 159, result);
  // Patch 11-9 # 160
  constant_a = -1;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 160, result);
  // Patch 11-10 # 161
  constant_a = 0;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 161, result);
  // Patch 11-11 # 162
  constant_a = 1;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 162, result);
  // Patch 11-12 # 163
  constant_a = 2;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 163, result);
  // Patch 11-13 # 164
  constant_a = 3;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 164, result);
  // Patch 11-14 # 165
  constant_a = 4;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 165, result);
  // Patch 11-15 # 166
  constant_a = 5;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 166, result);
  // Patch 11-16 # 167
  constant_a = 6;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 167, result);
  // Patch 11-17 # 168
  constant_a = 7;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 168, result);
  // Patch 11-18 # 169
  constant_a = 8;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 169, result);
  // Patch 11-19 # 170
  constant_a = 9;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 170, result);
  // Patch 11-20 # 171
  constant_a = 10;
  result = (constant_a < y);
  uni_klee_add_patch(patch_results, 171, result);
  // Patch 12-0 # 172
  constant_a = -10;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 172, result);
  // Patch 12-1 # 173
  constant_a = -9;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 173, result);
  // Patch 12-2 # 174
  constant_a = -8;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 174, result);
  // Patch 12-3 # 175
  constant_a = -7;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 175, result);
  // Patch 12-4 # 176
  constant_a = -6;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 176, result);
  // Patch 12-5 # 177
  constant_a = -5;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 177, result);
  // Patch 12-6 # 178
  constant_a = -4;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 178, result);
  // Patch 12-7 # 179
  constant_a = -3;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 179, result);
  // Patch 12-8 # 180
  constant_a = -2;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 180, result);
  // Patch 12-9 # 181
  constant_a = -1;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 181, result);
  // Patch 12-10 # 182
  constant_a = 0;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 182, result);
  // Patch 12-11 # 183
  constant_a = 1;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 183, result);
  // Patch 12-12 # 184
  constant_a = 2;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 184, result);
  // Patch 12-13 # 185
  constant_a = 3;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 185, result);
  // Patch 12-14 # 186
  constant_a = 4;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 186, result);
  // Patch 12-15 # 187
  constant_a = 5;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 187, result);
  // Patch 12-16 # 188
  constant_a = 6;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 188, result);
  // Patch 12-17 # 189
  constant_a = 7;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 189, result);
  // Patch 12-18 # 190
  constant_a = 8;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 190, result);
  // Patch 12-19 # 191
  constant_a = 9;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 191, result);
  // Patch 12-20 # 192
  constant_a = 10;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 192, result);
  // Patch 13-0 # 193
  constant_a = -10;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 193, result);
  // Patch 13-1 # 194
  constant_a = -9;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 194, result);
  // Patch 13-2 # 195
  constant_a = -8;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 195, result);
  // Patch 13-3 # 196
  constant_a = -7;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 196, result);
  // Patch 13-4 # 197
  constant_a = -6;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 197, result);
  // Patch 13-5 # 198
  constant_a = -5;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 198, result);
  // Patch 13-6 # 199
  constant_a = -4;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 199, result);
  // Patch 13-7 # 200
  constant_a = -3;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 200, result);
  // Patch 13-8 # 201
  constant_a = -2;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 201, result);
  // Patch 13-9 # 202
  constant_a = -1;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 202, result);
  // Patch 13-10 # 203
  constant_a = 0;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 203, result);
  // Patch 13-11 # 204
  constant_a = 1;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 204, result);
  // Patch 13-12 # 205
  constant_a = 2;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 205, result);
  // Patch 13-13 # 206
  constant_a = 3;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 206, result);
  // Patch 13-14 # 207
  constant_a = 4;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 207, result);
  // Patch 13-15 # 208
  constant_a = 5;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 208, result);
  // Patch 13-16 # 209
  constant_a = 6;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 209, result);
  // Patch 13-17 # 210
  constant_a = 7;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 210, result);
  // Patch 13-18 # 211
  constant_a = 8;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 211, result);
  // Patch 13-19 # 212
  constant_a = 9;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 212, result);
  // Patch 13-20 # 213
  constant_a = 10;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 213, result);
  // Patch 14-0 # 214
  constant_a = -10;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 214, result);
  // Patch 14-1 # 215
  constant_a = -9;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 215, result);
  // Patch 14-2 # 216
  constant_a = -8;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 216, result);
  // Patch 14-3 # 217
  constant_a = -7;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 217, result);
  // Patch 14-4 # 218
  constant_a = -6;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 218, result);
  // Patch 14-5 # 219
  constant_a = -5;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 219, result);
  // Patch 14-6 # 220
  constant_a = -4;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 220, result);
  // Patch 14-7 # 221
  constant_a = -3;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 221, result);
  // Patch 14-8 # 222
  constant_a = -2;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 222, result);
  // Patch 14-9 # 223
  constant_a = -1;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 223, result);
  // Patch 14-10 # 224
  constant_a = 0;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 224, result);
  // Patch 14-11 # 225
  constant_a = 1;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 225, result);
  // Patch 14-12 # 226
  constant_a = 2;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 226, result);
  // Patch 14-13 # 227
  constant_a = 3;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 227, result);
  // Patch 14-14 # 228
  constant_a = 4;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 228, result);
  // Patch 14-15 # 229
  constant_a = 5;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 229, result);
  // Patch 14-16 # 230
  constant_a = 6;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 230, result);
  // Patch 14-17 # 231
  constant_a = 7;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 231, result);
  // Patch 14-18 # 232
  constant_a = 8;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 232, result);
  // Patch 14-19 # 233
  constant_a = 9;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 233, result);
  // Patch 14-20 # 234
  constant_a = 10;
  result = (y <= constant_a);
  uni_klee_add_patch(patch_results, 234, result);
  // Patch 15-0 # 235
  result = (x <= y);
  uni_klee_add_patch(patch_results, 235, result);
  // Patch 16-0 # 236
  constant_a = -10;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 236, result);
  // Patch 16-1 # 237
  constant_a = -9;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 237, result);
  // Patch 16-2 # 238
  constant_a = -8;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 238, result);
  // Patch 16-3 # 239
  constant_a = -7;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 239, result);
  // Patch 16-4 # 240
  constant_a = -6;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 240, result);
  // Patch 16-5 # 241
  constant_a = -5;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 241, result);
  // Patch 16-6 # 242
  constant_a = -4;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 242, result);
  // Patch 16-7 # 243
  constant_a = -3;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 243, result);
  // Patch 16-8 # 244
  constant_a = -2;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 244, result);
  // Patch 16-9 # 245
  constant_a = -1;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 245, result);
  // Patch 16-10 # 246
  constant_a = 0;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 246, result);
  // Patch 16-11 # 247
  constant_a = 1;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 247, result);
  // Patch 16-12 # 248
  constant_a = 2;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 248, result);
  // Patch 16-13 # 249
  constant_a = 3;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 249, result);
  // Patch 16-14 # 250
  constant_a = 4;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 250, result);
  // Patch 16-15 # 251
  constant_a = 5;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 251, result);
  // Patch 16-16 # 252
  constant_a = 6;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 252, result);
  // Patch 16-17 # 253
  constant_a = 7;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 253, result);
  // Patch 16-18 # 254
  constant_a = 8;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 254, result);
  // Patch 16-19 # 255
  constant_a = 9;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 255, result);
  // Patch 16-20 # 256
  constant_a = 10;
  result = (constant_a <= y);
  uni_klee_add_patch(patch_results, 256, result);
  // Patch correct # 257
  result = (x == 0 || y == 0);
  uni_klee_add_patch(patch_results, 257, result);
  klee_select_patch(&uni_klee_patch_id);
  return uni_klee_choice(patch_results, uni_klee_patch_id);
}
// UNI_KLEE_END

#define	streq(a,b)	(strcmp(a,b) == 0)
#define	CopyField(tag, v) \
    if (TIFFGetField(in, tag, &v)) TIFFSetField(out, tag, v)

#ifndef howmany
#define	howmany(x, y)	(((x)+((y)-1))/(y))
#endif
#define	roundup(x, y)	(howmany(x,y)*((uint32)(y)))

#define	LumaRed		ycbcrCoeffs[0]
#define	LumaGreen	ycbcrCoeffs[1]
#define	LumaBlue	ycbcrCoeffs[2]
#ifndef CPR_OUTPUT
#define CPR_OUTPUT(id, typestr, value) value
#endif


uint16	compression = COMPRESSION_PACKBITS;
uint32	rowsperstrip = (uint32) -1;

uint16	horizSubSampling = 2;		/* YCbCr horizontal subsampling */
uint16	vertSubSampling = 2;		/* YCbCr vertical subsampling */
float	ycbcrCoeffs[3] = { .299F, .587F, .114F };
/* default coding range is CCIR Rec 601-1 with no headroom/footroom */
float	refBlackWhite[6] = { 0.F, 255.F, 128.F, 255.F, 128.F, 255.F };

static	int tiffcvt(TIFF* in, TIFF* out);
static	void usage(int code);
static	void setupLumaTables(void);

int
main(int argc, char* argv[])
{
	TIFF *in, *out;
	int c;
#if !HAVE_DECL_OPTARG
	extern int optind;
	extern char *optarg;
#endif

	while ((c = getopt(argc, argv, "c:h:r:v:z")) != -1)
		switch (c) {
		case 'c':
			if (streq(optarg, "none"))
			    compression = COMPRESSION_NONE;
			else if (streq(optarg, "packbits"))
			    compression = COMPRESSION_PACKBITS;
			else if (streq(optarg, "lzw"))
			    compression = COMPRESSION_LZW;
			else if (streq(optarg, "jpeg"))
			    compression = COMPRESSION_JPEG;
			else if (streq(optarg, "zip"))
			    compression = COMPRESSION_ADOBE_DEFLATE;
			else
			    usage(-1);
			break;
		case 'h':
			horizSubSampling = atoi(optarg);
			break;
		case 'v':
			vertSubSampling = atoi(optarg);
			break;
		case 'r':
			rowsperstrip = atoi(optarg);
			break;
		case 'z':	/* CCIR Rec 601-1 w/ headroom/footroom */
			refBlackWhite[0] = 16.;
			refBlackWhite[1] = 235.;
			refBlackWhite[2] = 128.;
			refBlackWhite[3] = 240.;
			refBlackWhite[4] = 128.;
			refBlackWhite[5] = 240.;
			break;
		case '?':
			usage(0);
			/*NOTREACHED*/
		}
	if (argc - optind < 2)
		usage(-1);
	out = TIFFOpen(argv[argc-1], "w");
	if (out == NULL)
		return (-2);
	setupLumaTables();
	for (; optind < argc-1; optind++) {
		in = TIFFOpen(argv[optind], "r");
		if (in != NULL) {
			do {
				if (!tiffcvt(in, out) ||
				    !TIFFWriteDirectory(out)) {
					(void) TIFFClose(out);
					return (1);
				}
			} while (TIFFReadDirectory(in));
			(void) TIFFClose(in);
		}
	}
	(void) TIFFClose(out);
	return (0);
}

float	*lumaRed;
float	*lumaGreen;
float	*lumaBlue;
float	D1, D2;
int	Yzero;

static float*
setupLuma(float c)
{
	float *v = (float *)_TIFFmalloc(256 * sizeof (float));
	int i;
	for (i = 0; i < 256; i++)
		v[i] = c * i;
	return (v);
}

static unsigned
V2Code(float f, float RB, float RW, int CR)
{
	unsigned int c = (unsigned int)((((f)*(RW-RB)/CR)+RB)+.5);
	return (c > 255 ? 255 : c);
}

static void
setupLumaTables(void)
{
	lumaRed = setupLuma(LumaRed);
	lumaGreen = setupLuma(LumaGreen);
	lumaBlue = setupLuma(LumaBlue);
	D1 = 1.F/(2.F - 2.F*LumaBlue);
	D2 = 1.F/(2.F - 2.F*LumaRed);
	Yzero = V2Code(0, refBlackWhite[0], refBlackWhite[1], 255);
}

static void
cvtClump(unsigned char* op, uint32* raster, uint32 ch, uint32 cw, uint32 w)
{
	float Y, Cb = 0, Cr = 0;
	uint32 j, k;
	/*
	 * Convert ch-by-cw block of RGB
	 * to YCbCr and sample accordingly.
	 */
	for (k = 0; k < ch; k++) {
		for (j = 0; j < cw; j++) {
			uint32 RGB = (raster - k*w)[j];
			Y = lumaRed[TIFFGetR(RGB)] +
			    lumaGreen[TIFFGetG(RGB)] +
			    lumaBlue[TIFFGetB(RGB)];
			/* accumulate chrominance */
			Cb += (TIFFGetB(RGB) - Y) * D1;
			Cr += (TIFFGetR(RGB) - Y) * D2;
			/* emit luminence */
			*op++ = V2Code(Y,
			    refBlackWhite[0], refBlackWhite[1], 255);
		}
		for (; j < horizSubSampling; j++)
			*op++ = Yzero;
	}
	for (; k < vertSubSampling; k++) {
		for (j = 0; j < horizSubSampling; j++)
			*op++ = Yzero;
	}
	/* emit sampled chrominance values */
	*op++ = V2Code(Cb / (ch*cw), refBlackWhite[2], refBlackWhite[3], 127);
	*op++ = V2Code(Cr / (ch*cw), refBlackWhite[4], refBlackWhite[5], 127);
}
#undef LumaRed
#undef LumaGreen
#undef LumaBlue
#undef V2Code

/*
 * Convert a strip of RGB data to YCbCr and
 * sample to generate the output data.
 */
static void
cvtStrip(unsigned char* op, uint32* raster, uint32 nrows, uint32 width)
{
	uint32 x;
	int clumpSize = vertSubSampling * horizSubSampling + 2;
	uint32 *tp;

	for (; nrows >= vertSubSampling; nrows -= vertSubSampling) {
		tp = raster;
		for (x = width; x >= horizSubSampling; x -= horizSubSampling) {
			cvtClump(op, tp,
			    vertSubSampling, horizSubSampling, width);
			op += clumpSize;
			tp += horizSubSampling;
		}
		if (x > 0) {
			cvtClump(op, tp, vertSubSampling, x, width);
			op += clumpSize;
		}
		raster -= vertSubSampling*width;
	}
	if (nrows > 0) {
		tp = raster;
		for (x = width; x >= horizSubSampling; x -= horizSubSampling) {
			cvtClump(op, tp, nrows, horizSubSampling, width);
			op += clumpSize;
			tp += horizSubSampling;
		}
		if (x > 0)
			cvtClump(op, tp, nrows, x, width);
	}
}

static int
cvtRaster(TIFF* tif, uint32* raster, uint32 width, uint32 height)
{
	uint32 y;
	tstrip_t strip = 0;
	tsize_t cc, acc;
	unsigned char* buf;
if(__cpr_choice("L816", "bool", (long long[]){horizSubSampling, vertSubSampling}, (char*[]){"x", "y"}, 2, (int*[]){}, (char*[]){}, 0)) usage(-1);

	uint32 rwidth = roundup(width, horizSubSampling);
	uint32 rheight = roundup(height, vertSubSampling);
	uint32 nrows = (rowsperstrip > rheight ? rheight : rowsperstrip);
        uint32 rnrows = roundup(nrows,vertSubSampling);

	cc = rnrows*rwidth +
	    2*((rnrows*rwidth) / (horizSubSampling*vertSubSampling));
	buf = (unsigned char*)_TIFFmalloc(cc);
	// FIXME unchecked malloc
	for (y = height; (int32) y > 0; y -= nrows) {
		uint32 nr = (y > nrows ? nrows : y);
		cvtStrip(buf, raster + (y-1)*width, nr, width);
		nr = roundup(nr, vertSubSampling);
		acc = nr*rwidth +
			2*((nr*rwidth)/(horizSubSampling*vertSubSampling));
		if (!TIFFWriteEncodedStrip(tif, strip++, buf, acc)) {
			_TIFFfree(buf);
			return (0);
		}
	}
	_TIFFfree(buf);
	return (1);
}

static int
tiffcvt(TIFF* in, TIFF* out)
{
	uint32 width, height;		/* image width & height */
	uint32* raster;			/* retrieve RGBA image */
	uint16 shortv;
	float floatv;
	char *stringv;
	uint32 longv;
	int result;
	size_t pixel_count;

	TIFFGetField(in, TIFFTAG_IMAGEWIDTH, &width);
	TIFFGetField(in, TIFFTAG_IMAGELENGTH, &height);
	pixel_count = width * height;

 	/* XXX: Check the integer overflow. */
 	if (!width || !height || pixel_count / width != height) {
 		TIFFError(TIFFFileName(in),
 			  "Malformed input file; "
 			  "can't allocate buffer for raster of %lux%lu size",
 			  (unsigned long)width, (unsigned long)height);
 		return 0;
 	}
 
 	raster = (uint32*)_TIFFCheckMalloc(in, pixel_count, sizeof(uint32),
 					   "raster buffer");
  	if (raster == 0) {
 		TIFFError(TIFFFileName(in),
 			  "Failed to allocate buffer (%lu elements of %lu each)",
 			  (unsigned long)pixel_count,
 			  (unsigned long)sizeof(uint32));
  		return (0);
  	}

	if (!TIFFReadRGBAImage(in, width, height, raster, 0)) {
		_TIFFfree(raster);
		return (0);
	}

	CopyField(TIFFTAG_SUBFILETYPE, longv);
	TIFFSetField(out, TIFFTAG_IMAGEWIDTH, width);
	TIFFSetField(out, TIFFTAG_IMAGELENGTH, height);
	TIFFSetField(out, TIFFTAG_BITSPERSAMPLE, 8);
	TIFFSetField(out, TIFFTAG_COMPRESSION, compression);
	TIFFSetField(out, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_YCBCR);
	if (compression == COMPRESSION_JPEG)
		TIFFSetField(out, TIFFTAG_JPEGCOLORMODE, JPEGCOLORMODE_RAW);
	CopyField(TIFFTAG_FILLORDER, shortv);
	TIFFSetField(out, TIFFTAG_ORIENTATION, ORIENTATION_TOPLEFT);
	TIFFSetField(out, TIFFTAG_SAMPLESPERPIXEL, 3);
	CopyField(TIFFTAG_XRESOLUTION, floatv);
	CopyField(TIFFTAG_YRESOLUTION, floatv);
	CopyField(TIFFTAG_RESOLUTIONUNIT, shortv);
	TIFFSetField(out, TIFFTAG_PLANARCONFIG, PLANARCONFIG_CONTIG);
	{ char buf[2048];
	  char *cp = strrchr(TIFFFileName(in), '/');
	  snprintf(buf, sizeof(buf), "YCbCr conversion of %s",
		   cp ? cp+1 : TIFFFileName(in));
	  TIFFSetField(out, TIFFTAG_IMAGEDESCRIPTION, buf);
	}
	TIFFSetField(out, TIFFTAG_SOFTWARE, TIFFGetVersion());
	CopyField(TIFFTAG_DOCUMENTNAME, stringv);

	TIFFSetField(out, TIFFTAG_REFERENCEBLACKWHITE, refBlackWhite);
	TIFFSetField(out, TIFFTAG_YCBCRSUBSAMPLING,
	    horizSubSampling, vertSubSampling);
	TIFFSetField(out, TIFFTAG_YCBCRPOSITIONING, YCBCRPOSITION_CENTERED);
	TIFFSetField(out, TIFFTAG_YCBCRCOEFFICIENTS, ycbcrCoeffs);
	rowsperstrip = TIFFDefaultStripSize(out, rowsperstrip);
	TIFFSetField(out, TIFFTAG_ROWSPERSTRIP, rowsperstrip);

	result = cvtRaster(out, raster, width, height);
        _TIFFfree(raster);
        return result;
}

char* stuff[] = {
    "usage: rgb2ycbcr [-c comp] [-r rows] [-h N] [-v N] input... output\n",
    "where comp is one of the following compression algorithms:\n",
    " jpeg\t\tJPEG encoding\n",
    " lzw\t\tLempel-Ziv & Welch encoding\n",
    " zip\t\tdeflate encoding\n",
    " packbits\tPackBits encoding (default)\n",
    " none\t\tno compression\n",
    "and the other options are:\n",
    " -r\trows/strip\n",
    " -h\thorizontal sampling factor (1,2,4)\n",
    " -v\tvertical sampling factor (1,2,4)\n",
    NULL
};

static void
usage(int code)
{
	char buf[BUFSIZ];
	int i;

	setbuf(stderr, buf);
       
 fprintf(stderr, "%s\n\n", TIFFGetVersion());
	for (i = 0; stuff[i] != NULL; i++)
		fprintf(stderr, "%s\n", stuff[i]);
	exit(code);
}

/* vim: set ts=8 sts=8 sw=8 noet: */
/*
 * Local Variables:
 * mode: c
 * c-basic-offset: 8
 * fill-column: 78
 * End:
 */
