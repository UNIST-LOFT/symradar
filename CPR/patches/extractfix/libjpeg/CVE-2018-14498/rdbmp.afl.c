/*
 * rdbmp.c
 *
 * This file was part of the Independent JPEG Group's software:
 * Copyright (C) 1994-1996, Thomas G. Lane.
 * Modified 2009-2010 by Guido Vollbeding.
 * libjpeg-turbo Modifications:
 * Modified 2011 by Siarhei Siamashka.
 * Copyright (C) 2015, 2018, D. R. Commander.
 * For conditions of distribution and use, see the accompanying README.ijg
 * file.
 *
 * This file contains routines to read input images in Microsoft "BMP"
 * format (MS Windows 3.x, OS/2 1.x, and OS/2 2.x flavors).
 * Currently, only 8-bit and 24-bit images are supported, not 1-bit or
 * 4-bit (feeding such low-depth images into JPEG would be silly anyway).
 * Also, we don't support RLE-compressed files.
 *
 * These routines may need modification for non-Unix environments or
 * specialized applications.  As they stand, they assume input from
 * an ordinary stdio stream.  They further assume that reading begins
 * at the start of the file; start_input may need work if the
 * user interface has already read some data (e.g., to determine that
 * the file is indeed BMP format).
 *
 * This code contributed by James Arthur Boucher.
 */

#include "cdjpeg.h"             /* Common decls for cjpeg/djpeg applications */

int uni_klee_patch_id;

void klee_select_patch(int *patch_id) {
  *patch_id = atoi(getenv("DAFL_PATCH_ID"));
}

void uni_klee_add_patch(int *patch_results, int patch_id, int result) {
  patch_results[patch_id] = result;
}

int uni_klee_choice(int *patch_results, int patch_id) {
  // FILE *fp=fopen(getenv("DAFL_RESULT_FILE"),"a");
  // if (fp == NULL) {
  //   fprintf(stderr, "Error opening file!\n");
  //   exit(1);
  // }
  // fprintf(fp, "%d ", patch_results[patch_id]);
  // fclose(fp);
  return patch_results[patch_id];
}

// UNI_KLEE_START
int __cpr_choice(char* lid, char* typestr,
                     long long* rvals, char** rvals_ids, int rvals_size,
                     int** lvals, char** lvals_ids, int lvals_size){
  // int patch_results[4096];
  int result;
  long long x = rvals[0];
  long long t = rvals[1];
  long long constant_a;
  int patch_results[262];
  // Patch buggy # 0
  result = (0);
  uni_klee_add_patch(patch_results, 0, result);
  // Patch 1-0 # 1
  result = (x == x);
  uni_klee_add_patch(patch_results, 1, result);
  // Patch 2-0 # 2
  result = (t == x);
  uni_klee_add_patch(patch_results, 2, result);
  // Patch 3-0 # 3
  constant_a = -10;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 3, result);
  // Patch 3-1 # 4
  constant_a = -9;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 4, result);
  // Patch 3-2 # 5
  constant_a = -8;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 5, result);
  // Patch 3-3 # 6
  constant_a = -7;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 6, result);
  // Patch 3-4 # 7
  constant_a = -6;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 7, result);
  // Patch 3-5 # 8
  constant_a = -5;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 8, result);
  // Patch 3-6 # 9
  constant_a = -4;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 9, result);
  // Patch 3-7 # 10
  constant_a = -3;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 10, result);
  // Patch 3-8 # 11
  constant_a = -2;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 11, result);
  // Patch 3-9 # 12
  constant_a = -1;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 12, result);
  // Patch 3-10 # 13
  constant_a = 0;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 13, result);
  // Patch 3-11 # 14
  constant_a = 1;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 14, result);
  // Patch 3-12 # 15
  constant_a = 2;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 15, result);
  // Patch 3-13 # 16
  constant_a = 3;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 16, result);
  // Patch 3-14 # 17
  constant_a = 4;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 17, result);
  // Patch 3-15 # 18
  constant_a = 5;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 18, result);
  // Patch 3-16 # 19
  constant_a = 6;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 19, result);
  // Patch 3-17 # 20
  constant_a = 7;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 20, result);
  // Patch 3-18 # 21
  constant_a = 8;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 21, result);
  // Patch 3-19 # 22
  constant_a = 9;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 22, result);
  // Patch 3-20 # 23
  constant_a = 10;
  result = (constant_a == x);
  uni_klee_add_patch(patch_results, 23, result);
  // Patch 4-0 # 24
  constant_a = -10;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 24, result);
  // Patch 4-1 # 25
  constant_a = -9;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 25, result);
  // Patch 4-2 # 26
  constant_a = -8;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 26, result);
  // Patch 4-3 # 27
  constant_a = -7;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 27, result);
  // Patch 4-4 # 28
  constant_a = -6;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 28, result);
  // Patch 4-5 # 29
  constant_a = -5;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 29, result);
  // Patch 4-6 # 30
  constant_a = -4;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 30, result);
  // Patch 4-7 # 31
  constant_a = -3;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 31, result);
  // Patch 4-8 # 32
  constant_a = -2;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 32, result);
  // Patch 4-9 # 33
  constant_a = -1;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 33, result);
  // Patch 4-10 # 34
  constant_a = 0;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 34, result);
  // Patch 4-11 # 35
  constant_a = 1;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 35, result);
  // Patch 4-12 # 36
  constant_a = 2;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 36, result);
  // Patch 4-13 # 37
  constant_a = 3;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 37, result);
  // Patch 4-14 # 38
  constant_a = 4;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 38, result);
  // Patch 4-15 # 39
  constant_a = 5;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 39, result);
  // Patch 4-16 # 40
  constant_a = 6;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 40, result);
  // Patch 4-17 # 41
  constant_a = 7;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 41, result);
  // Patch 4-18 # 42
  constant_a = 8;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 42, result);
  // Patch 4-19 # 43
  constant_a = 9;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 43, result);
  // Patch 4-20 # 44
  constant_a = 10;
  result = (constant_a == t);
  uni_klee_add_patch(patch_results, 44, result);
  // Patch 5-0 # 45
  result = (x != x);
  uni_klee_add_patch(patch_results, 45, result);
  // Patch 6-0 # 46
  result = (t != x);
  uni_klee_add_patch(patch_results, 46, result);
  // Patch 7-0 # 47
  constant_a = -10;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 47, result);
  // Patch 7-1 # 48
  constant_a = -9;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 48, result);
  // Patch 7-2 # 49
  constant_a = -8;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 49, result);
  // Patch 7-3 # 50
  constant_a = -7;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 50, result);
  // Patch 7-4 # 51
  constant_a = -6;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 51, result);
  // Patch 7-5 # 52
  constant_a = -5;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 52, result);
  // Patch 7-6 # 53
  constant_a = -4;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 53, result);
  // Patch 7-7 # 54
  constant_a = -3;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 54, result);
  // Patch 7-8 # 55
  constant_a = -2;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 55, result);
  // Patch 7-9 # 56
  constant_a = -1;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 56, result);
  // Patch 7-10 # 57
  constant_a = 0;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 57, result);
  // Patch 7-11 # 58
  constant_a = 1;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 58, result);
  // Patch 7-12 # 59
  constant_a = 2;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 59, result);
  // Patch 7-13 # 60
  constant_a = 3;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 60, result);
  // Patch 7-14 # 61
  constant_a = 4;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 61, result);
  // Patch 7-15 # 62
  constant_a = 5;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 62, result);
  // Patch 7-16 # 63
  constant_a = 6;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 63, result);
  // Patch 7-17 # 64
  constant_a = 7;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 64, result);
  // Patch 7-18 # 65
  constant_a = 8;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 65, result);
  // Patch 7-19 # 66
  constant_a = 9;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 66, result);
  // Patch 7-20 # 67
  constant_a = 10;
  result = (constant_a != x);
  uni_klee_add_patch(patch_results, 67, result);
  // Patch 8-0 # 68
  constant_a = -10;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 68, result);
  // Patch 8-1 # 69
  constant_a = -9;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 69, result);
  // Patch 8-2 # 70
  constant_a = -8;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 70, result);
  // Patch 8-3 # 71
  constant_a = -7;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 71, result);
  // Patch 8-4 # 72
  constant_a = -6;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 72, result);
  // Patch 8-5 # 73
  constant_a = -5;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 73, result);
  // Patch 8-6 # 74
  constant_a = -4;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 74, result);
  // Patch 8-7 # 75
  constant_a = -3;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 75, result);
  // Patch 8-8 # 76
  constant_a = -2;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 76, result);
  // Patch 8-9 # 77
  constant_a = -1;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 77, result);
  // Patch 8-10 # 78
  constant_a = 0;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 78, result);
  // Patch 8-11 # 79
  constant_a = 1;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 79, result);
  // Patch 8-12 # 80
  constant_a = 2;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 80, result);
  // Patch 8-13 # 81
  constant_a = 3;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 81, result);
  // Patch 8-14 # 82
  constant_a = 4;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 82, result);
  // Patch 8-15 # 83
  constant_a = 5;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 83, result);
  // Patch 8-16 # 84
  constant_a = 6;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 84, result);
  // Patch 8-17 # 85
  constant_a = 7;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 85, result);
  // Patch 8-18 # 86
  constant_a = 8;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 86, result);
  // Patch 8-19 # 87
  constant_a = 9;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 87, result);
  // Patch 8-20 # 88
  constant_a = 10;
  result = (constant_a != t);
  uni_klee_add_patch(patch_results, 88, result);
  // Patch 9-0 # 89
  result = (t < x);
  uni_klee_add_patch(patch_results, 89, result);
  // Patch 10-0 # 90
  constant_a = -10;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 90, result);
  // Patch 10-1 # 91
  constant_a = -9;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 91, result);
  // Patch 10-2 # 92
  constant_a = -8;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 92, result);
  // Patch 10-3 # 93
  constant_a = -7;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 93, result);
  // Patch 10-4 # 94
  constant_a = -6;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 94, result);
  // Patch 10-5 # 95
  constant_a = -5;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 95, result);
  // Patch 10-6 # 96
  constant_a = -4;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 96, result);
  // Patch 10-7 # 97
  constant_a = -3;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 97, result);
  // Patch 10-8 # 98
  constant_a = -2;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 98, result);
  // Patch 10-9 # 99
  constant_a = -1;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 99, result);
  // Patch 10-10 # 100
  constant_a = 0;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 100, result);
  // Patch 10-11 # 101
  constant_a = 1;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 101, result);
  // Patch 10-12 # 102
  constant_a = 2;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 102, result);
  // Patch 10-13 # 103
  constant_a = 3;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 103, result);
  // Patch 10-14 # 104
  constant_a = 4;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 104, result);
  // Patch 10-15 # 105
  constant_a = 5;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 105, result);
  // Patch 10-16 # 106
  constant_a = 6;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 106, result);
  // Patch 10-17 # 107
  constant_a = 7;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 107, result);
  // Patch 10-18 # 108
  constant_a = 8;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 108, result);
  // Patch 10-19 # 109
  constant_a = 9;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 109, result);
  // Patch 10-20 # 110
  constant_a = 10;
  result = (constant_a < x);
  uni_klee_add_patch(patch_results, 110, result);
  // Patch 11-0 # 111
  result = (x < t);
  uni_klee_add_patch(patch_results, 111, result);
  // Patch 12-0 # 112
  constant_a = -10;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 112, result);
  // Patch 12-1 # 113
  constant_a = -9;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 113, result);
  // Patch 12-2 # 114
  constant_a = -8;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 114, result);
  // Patch 12-3 # 115
  constant_a = -7;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 115, result);
  // Patch 12-4 # 116
  constant_a = -6;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 116, result);
  // Patch 12-5 # 117
  constant_a = -5;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 117, result);
  // Patch 12-6 # 118
  constant_a = -4;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 118, result);
  // Patch 12-7 # 119
  constant_a = -3;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 119, result);
  // Patch 12-8 # 120
  constant_a = -2;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 120, result);
  // Patch 12-9 # 121
  constant_a = -1;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 121, result);
  // Patch 12-10 # 122
  constant_a = 0;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 122, result);
  // Patch 12-11 # 123
  constant_a = 1;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 123, result);
  // Patch 12-12 # 124
  constant_a = 2;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 124, result);
  // Patch 12-13 # 125
  constant_a = 3;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 125, result);
  // Patch 12-14 # 126
  constant_a = 4;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 126, result);
  // Patch 12-15 # 127
  constant_a = 5;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 127, result);
  // Patch 12-16 # 128
  constant_a = 6;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 128, result);
  // Patch 12-17 # 129
  constant_a = 7;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 129, result);
  // Patch 12-18 # 130
  constant_a = 8;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 130, result);
  // Patch 12-19 # 131
  constant_a = 9;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 131, result);
  // Patch 12-20 # 132
  constant_a = 10;
  result = (constant_a < t);
  uni_klee_add_patch(patch_results, 132, result);
  // Patch 13-0 # 133
  constant_a = -10;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 133, result);
  // Patch 13-1 # 134
  constant_a = -9;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 134, result);
  // Patch 13-2 # 135
  constant_a = -8;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 135, result);
  // Patch 13-3 # 136
  constant_a = -7;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 136, result);
  // Patch 13-4 # 137
  constant_a = -6;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 137, result);
  // Patch 13-5 # 138
  constant_a = -5;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 138, result);
  // Patch 13-6 # 139
  constant_a = -4;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 139, result);
  // Patch 13-7 # 140
  constant_a = -3;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 140, result);
  // Patch 13-8 # 141
  constant_a = -2;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 141, result);
  // Patch 13-9 # 142
  constant_a = -1;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 142, result);
  // Patch 13-10 # 143
  constant_a = 0;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 143, result);
  // Patch 13-11 # 144
  constant_a = 1;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 144, result);
  // Patch 13-12 # 145
  constant_a = 2;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 145, result);
  // Patch 13-13 # 146
  constant_a = 3;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 146, result);
  // Patch 13-14 # 147
  constant_a = 4;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 147, result);
  // Patch 13-15 # 148
  constant_a = 5;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 148, result);
  // Patch 13-16 # 149
  constant_a = 6;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 149, result);
  // Patch 13-17 # 150
  constant_a = 7;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 150, result);
  // Patch 13-18 # 151
  constant_a = 8;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 151, result);
  // Patch 13-19 # 152
  constant_a = 9;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 152, result);
  // Patch 13-20 # 153
  constant_a = 10;
  result = (x < constant_a);
  uni_klee_add_patch(patch_results, 153, result);
  // Patch 14-0 # 154
  constant_a = -10;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 154, result);
  // Patch 14-1 # 155
  constant_a = -9;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 155, result);
  // Patch 14-2 # 156
  constant_a = -8;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 156, result);
  // Patch 14-3 # 157
  constant_a = -7;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 157, result);
  // Patch 14-4 # 158
  constant_a = -6;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 158, result);
  // Patch 14-5 # 159
  constant_a = -5;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 159, result);
  // Patch 14-6 # 160
  constant_a = -4;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 160, result);
  // Patch 14-7 # 161
  constant_a = -3;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 161, result);
  // Patch 14-8 # 162
  constant_a = -2;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 162, result);
  // Patch 14-9 # 163
  constant_a = -1;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 163, result);
  // Patch 14-10 # 164
  constant_a = 0;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 164, result);
  // Patch 14-11 # 165
  constant_a = 1;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 165, result);
  // Patch 14-12 # 166
  constant_a = 2;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 166, result);
  // Patch 14-13 # 167
  constant_a = 3;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 167, result);
  // Patch 14-14 # 168
  constant_a = 4;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 168, result);
  // Patch 14-15 # 169
  constant_a = 5;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 169, result);
  // Patch 14-16 # 170
  constant_a = 6;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 170, result);
  // Patch 14-17 # 171
  constant_a = 7;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 171, result);
  // Patch 14-18 # 172
  constant_a = 8;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 172, result);
  // Patch 14-19 # 173
  constant_a = 9;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 173, result);
  // Patch 14-20 # 174
  constant_a = 10;
  result = (t < constant_a);
  uni_klee_add_patch(patch_results, 174, result);
  // Patch 15-0 # 175
  result = (t <= x);
  uni_klee_add_patch(patch_results, 175, result);
  // Patch 16-0 # 176
  constant_a = -10;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 176, result);
  // Patch 16-1 # 177
  constant_a = -9;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 177, result);
  // Patch 16-2 # 178
  constant_a = -8;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 178, result);
  // Patch 16-3 # 179
  constant_a = -7;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 179, result);
  // Patch 16-4 # 180
  constant_a = -6;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 180, result);
  // Patch 16-5 # 181
  constant_a = -5;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 181, result);
  // Patch 16-6 # 182
  constant_a = -4;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 182, result);
  // Patch 16-7 # 183
  constant_a = -3;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 183, result);
  // Patch 16-8 # 184
  constant_a = -2;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 184, result);
  // Patch 16-9 # 185
  constant_a = -1;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 185, result);
  // Patch 16-10 # 186
  constant_a = 0;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 186, result);
  // Patch 16-11 # 187
  constant_a = 1;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 187, result);
  // Patch 16-12 # 188
  constant_a = 2;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 188, result);
  // Patch 16-13 # 189
  constant_a = 3;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 189, result);
  // Patch 16-14 # 190
  constant_a = 4;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 190, result);
  // Patch 16-15 # 191
  constant_a = 5;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 191, result);
  // Patch 16-16 # 192
  constant_a = 6;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 192, result);
  // Patch 16-17 # 193
  constant_a = 7;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 193, result);
  // Patch 16-18 # 194
  constant_a = 8;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 194, result);
  // Patch 16-19 # 195
  constant_a = 9;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 195, result);
  // Patch 16-20 # 196
  constant_a = 10;
  result = (constant_a <= x);
  uni_klee_add_patch(patch_results, 196, result);
  // Patch 17-0 # 197
  result = (x <= t);
  uni_klee_add_patch(patch_results, 197, result);
  // Patch 18-0 # 198
  constant_a = -10;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 198, result);
  // Patch 18-1 # 199
  constant_a = -9;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 199, result);
  // Patch 18-2 # 200
  constant_a = -8;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 200, result);
  // Patch 18-3 # 201
  constant_a = -7;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 201, result);
  // Patch 18-4 # 202
  constant_a = -6;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 202, result);
  // Patch 18-5 # 203
  constant_a = -5;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 203, result);
  // Patch 18-6 # 204
  constant_a = -4;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 204, result);
  // Patch 18-7 # 205
  constant_a = -3;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 205, result);
  // Patch 18-8 # 206
  constant_a = -2;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 206, result);
  // Patch 18-9 # 207
  constant_a = -1;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 207, result);
  // Patch 18-10 # 208
  constant_a = 0;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 208, result);
  // Patch 18-11 # 209
  constant_a = 1;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 209, result);
  // Patch 18-12 # 210
  constant_a = 2;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 210, result);
  // Patch 18-13 # 211
  constant_a = 3;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 211, result);
  // Patch 18-14 # 212
  constant_a = 4;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 212, result);
  // Patch 18-15 # 213
  constant_a = 5;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 213, result);
  // Patch 18-16 # 214
  constant_a = 6;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 214, result);
  // Patch 18-17 # 215
  constant_a = 7;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 215, result);
  // Patch 18-18 # 216
  constant_a = 8;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 216, result);
  // Patch 18-19 # 217
  constant_a = 9;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 217, result);
  // Patch 18-20 # 218
  constant_a = 10;
  result = (constant_a <= t);
  uni_klee_add_patch(patch_results, 218, result);
  // Patch 19-0 # 219
  constant_a = -10;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 219, result);
  // Patch 19-1 # 220
  constant_a = -9;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 220, result);
  // Patch 19-2 # 221
  constant_a = -8;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 221, result);
  // Patch 19-3 # 222
  constant_a = -7;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 222, result);
  // Patch 19-4 # 223
  constant_a = -6;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 223, result);
  // Patch 19-5 # 224
  constant_a = -5;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 224, result);
  // Patch 19-6 # 225
  constant_a = -4;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 225, result);
  // Patch 19-7 # 226
  constant_a = -3;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 226, result);
  // Patch 19-8 # 227
  constant_a = -2;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 227, result);
  // Patch 19-9 # 228
  constant_a = -1;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 228, result);
  // Patch 19-10 # 229
  constant_a = 0;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 229, result);
  // Patch 19-11 # 230
  constant_a = 1;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 230, result);
  // Patch 19-12 # 231
  constant_a = 2;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 231, result);
  // Patch 19-13 # 232
  constant_a = 3;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 232, result);
  // Patch 19-14 # 233
  constant_a = 4;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 233, result);
  // Patch 19-15 # 234
  constant_a = 5;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 234, result);
  // Patch 19-16 # 235
  constant_a = 6;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 235, result);
  // Patch 19-17 # 236
  constant_a = 7;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 236, result);
  // Patch 19-18 # 237
  constant_a = 8;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 237, result);
  // Patch 19-19 # 238
  constant_a = 9;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 238, result);
  // Patch 19-20 # 239
  constant_a = 10;
  result = (x <= constant_a);
  uni_klee_add_patch(patch_results, 239, result);
  // Patch 20-0 # 240
  constant_a = -10;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 240, result);
  // Patch 20-1 # 241
  constant_a = -9;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 241, result);
  // Patch 20-2 # 242
  constant_a = -8;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 242, result);
  // Patch 20-3 # 243
  constant_a = -7;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 243, result);
  // Patch 20-4 # 244
  constant_a = -6;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 244, result);
  // Patch 20-5 # 245
  constant_a = -5;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 245, result);
  // Patch 20-6 # 246
  constant_a = -4;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 246, result);
  // Patch 20-7 # 247
  constant_a = -3;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 247, result);
  // Patch 20-8 # 248
  constant_a = -2;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 248, result);
  // Patch 20-9 # 249
  constant_a = -1;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 249, result);
  // Patch 20-10 # 250
  constant_a = 0;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 250, result);
  // Patch 20-11 # 251
  constant_a = 1;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 251, result);
  // Patch 20-12 # 252
  constant_a = 2;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 252, result);
  // Patch 20-13 # 253
  constant_a = 3;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 253, result);
  // Patch 20-14 # 254
  constant_a = 4;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 254, result);
  // Patch 20-15 # 255
  constant_a = 5;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 255, result);
  // Patch 20-16 # 256
  constant_a = 6;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 256, result);
  // Patch 20-17 # 257
  constant_a = 7;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 257, result);
  // Patch 20-18 # 258
  constant_a = 8;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 258, result);
  // Patch 20-19 # 259
  constant_a = 9;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 259, result);
  // Patch 20-20 # 260
  constant_a = 10;
  result = (t <= constant_a);
  uni_klee_add_patch(patch_results, 260, result);
  // Patch correct # 261
  result = (t >= x);
  uni_klee_add_patch(patch_results, 261, result);
  klee_select_patch(&uni_klee_patch_id);
  return uni_klee_choice(patch_results, uni_klee_patch_id);
}
// UNI_KLEE_END

#ifdef BMP_SUPPORTED


/* Macros to deal with unsigned chars as efficiently as compiler allows */

#ifdef HAVE_UNSIGNED_CHAR
typedef unsigned char U_CHAR;
#define UCH(x)  ((int) (x))
#else /* !HAVE_UNSIGNED_CHAR */
#ifdef __CHAR_UNSIGNED__
typedef char U_CHAR;
#define UCH(x)  ((int) (x))
#else
typedef char U_CHAR;
#define UCH(x)  ((int) (x) & 0xFF)
#endif
#endif /* HAVE_UNSIGNED_CHAR */


#define ReadOK(file,buffer,len) (JFREAD(file,buffer,len) == ((size_t) (len)))


/* Private version of data source object */

typedef struct _bmp_source_struct *bmp_source_ptr;

typedef struct _bmp_source_struct {
  struct cjpeg_source_struct pub; /* public fields */

  j_compress_ptr cinfo;         /* back link saves passing separate parm */

  JSAMPARRAY colormap;          /* BMP colormap (converted to my format) */

  jvirt_sarray_ptr whole_image; /* Needed to reverse row order */
  JDIMENSION source_row;        /* Current source row number */
  JDIMENSION row_width;         /* Physical width of scanlines in file */

int cmap_length; 
  int bits_per_pixel;           /* remembers 8- or 24-bit format */
} bmp_source_struct;


LOCAL(int)
read_byte (bmp_source_ptr sinfo)
/* Read next byte from BMP file */
{
  register FILE *infile = sinfo->pub.input_file;
  register int c;

  if ((c = getc(infile)) == EOF)
    ERREXIT(sinfo->cinfo, JERR_INPUT_EOF);
  return c;
}


LOCAL(void)
read_colormap (bmp_source_ptr sinfo, int cmaplen, int mapentrysize)
/* Read the colormap from a BMP file */
{
  int i;

  switch (mapentrysize) {
  case 3:
    /* BGR format (occurs in OS/2 files) */
    for (i = 0; i < cmaplen; i++) {
      sinfo->colormap[2][i] = (JSAMPLE) read_byte(sinfo);
      sinfo->colormap[1][i] = (JSAMPLE) read_byte(sinfo);
      sinfo->colormap[0][i] = (JSAMPLE) read_byte(sinfo);
    }
    break;
  case 4:
    /* BGR0 format (occurs in MS Windows files) */
    for (i = 0; i < cmaplen; i++) {
      sinfo->colormap[2][i] = (JSAMPLE) read_byte(sinfo);
      sinfo->colormap[1][i] = (JSAMPLE) read_byte(sinfo);
      sinfo->colormap[0][i] = (JSAMPLE) read_byte(sinfo);
      (void) read_byte(sinfo);
    }
    break;
  default:
    ERREXIT(sinfo->cinfo, JERR_BMP_BADCMAP);
    break;
  }
}


/*
 * Read one row of pixels.
 * The image has been read into the whole_image array, but is otherwise
 * unprocessed.  We must read it out in top-to-bottom row order, and if
 * it is an 8-bit image, we must expand colormapped pixels to 24bit format.
 */

METHODDEF(JDIMENSION)
get_8bit_row (j_compress_ptr cinfo, cjpeg_source_ptr sinfo)
/* This version is for reading 8-bit colormap indexes */
{
  bmp_source_ptr source = (bmp_source_ptr) sinfo;
  register JSAMPARRAY colormap = source->colormap;
  JSAMPARRAY image_ptr;
  register int t;
  register JSAMPROW inptr, outptr;
  register JDIMENSION col;

  /* Fetch next row from virtual array */
  source->source_row--;
  image_ptr = (*cinfo->mem->access_virt_sarray)
    ((j_common_ptr) cinfo, source->whole_image,
     source->source_row, (JDIMENSION) 1, FALSE);

  /* Expand the colormap indexes to real data */
  inptr = image_ptr[0];
  outptr = source->pub.buffer[0];
  for (col = cinfo->image_width; col > 0; col--) {
    t = GETJSAMPLE(*inptr++);
if(__cpr_choice("L1229", "bool", (long long[]){source->cmap_length, t}, (char*[]){"x", "t"}, 2, (int*[]){}, (char*[]){}, 0)) exit(0);


    *outptr++ = colormap[0][t]; /* can omit GETJSAMPLE() safely */
    *outptr++ = colormap[1][t];
    *outptr++ = colormap[2][t];
  }

  return 1;
}


METHODDEF(JDIMENSION)
get_24bit_row (j_compress_ptr cinfo, cjpeg_source_ptr sinfo)
/* This version is for reading 24-bit pixels */
{
  bmp_source_ptr source = (bmp_source_ptr) sinfo;
  JSAMPARRAY image_ptr;
  register JSAMPROW inptr, outptr;
  register JDIMENSION col;

  /* Fetch next row from virtual array */
  source->source_row--;
  image_ptr = (*cinfo->mem->access_virt_sarray)
    ((j_common_ptr) cinfo, source->whole_image,
     source->source_row, (JDIMENSION) 1, FALSE);

  /* Transfer data.  Note source values are in BGR order
   * (even though Microsoft's own documents say the opposite).
   */
  inptr = image_ptr[0];
  outptr = source->pub.buffer[0];
  for (col = cinfo->image_width; col > 0; col--) {
    outptr[2] = *inptr++;       /* can omit GETJSAMPLE() safely */
    outptr[1] = *inptr++;
    outptr[0] = *inptr++;
    outptr += 3;
  }

  return 1;
}


METHODDEF(JDIMENSION)
get_32bit_row (j_compress_ptr cinfo, cjpeg_source_ptr sinfo)
/* This version is for reading 32-bit pixels */
{
  bmp_source_ptr source = (bmp_source_ptr) sinfo;
  JSAMPARRAY image_ptr;
  register JSAMPROW inptr, outptr;
  register JDIMENSION col;

  /* Fetch next row from virtual array */
  source->source_row--;
  image_ptr = (*cinfo->mem->access_virt_sarray)
    ((j_common_ptr) cinfo, source->whole_image,
     source->source_row, (JDIMENSION) 1, FALSE);
  /* Transfer data.  Note source values are in BGR order
   * (even though Microsoft's own documents say the opposite).
   */
  inptr = image_ptr[0];
  outptr = source->pub.buffer[0];
  for (col = cinfo->image_width; col > 0; col--) {
    outptr[2] = *inptr++;       /* can omit GETJSAMPLE() safely */
    outptr[1] = *inptr++;
    outptr[0] = *inptr++;
    inptr++;                    /* skip the 4th byte (Alpha channel) */
    outptr += 3;
  }

  return 1;
}


/*
 * This method loads the image into whole_image during the first call on
 * get_pixel_rows.  The get_pixel_rows pointer is then adjusted to call
 * get_8bit_row, get_24bit_row, or get_32bit_row on subsequent calls.
 */

METHODDEF(JDIMENSION)
preload_image (j_compress_ptr cinfo, cjpeg_source_ptr sinfo)
{
  bmp_source_ptr source = (bmp_source_ptr) sinfo;
  register FILE *infile = source->pub.input_file;
  register JSAMPROW out_ptr;
  JSAMPARRAY image_ptr;
  JDIMENSION row;
  cd_progress_ptr progress = (cd_progress_ptr) cinfo->progress;

  /* Read the data into a virtual array in input-file row order. */
  for (row = 0; row < cinfo->image_height; row++) {
    if (progress != NULL) {
      progress->pub.pass_counter = (long) row;
      progress->pub.pass_limit = (long) cinfo->image_height;
      (*progress->pub.progress_monitor) ((j_common_ptr) cinfo);
    }
    image_ptr = (*cinfo->mem->access_virt_sarray)
      ((j_common_ptr) cinfo, source->whole_image,
       row, (JDIMENSION) 1, TRUE);
    out_ptr = image_ptr[0];
    if (fread(out_ptr, 1, source->row_width, infile) != source->row_width) {
      if (feof(infile))
        ERREXIT(cinfo, JERR_INPUT_EOF);
      else
        ERREXIT(cinfo, JERR_FILE_READ);
    }
  }
  if (progress != NULL)
    progress->completed_extra_passes++;

  /* Set up to read from the virtual array in top-to-bottom order */
  switch (source->bits_per_pixel) {
  case 8:
    source->pub.get_pixel_rows = get_8bit_row;
    break;
  case 24:
    source->pub.get_pixel_rows = get_24bit_row;
    break;
  case 32:
    source->pub.get_pixel_rows = get_32bit_row;
    break;
  default:
    ERREXIT(cinfo, JERR_BMP_BADDEPTH);
  }
  source->source_row = cinfo->image_height;

  /* And read the first row */
  return (*source->pub.get_pixel_rows) (cinfo, sinfo);
}


/*
 * Read the file header; return image size and component count.
 */

METHODDEF(void)
start_input_bmp (j_compress_ptr cinfo, cjpeg_source_ptr sinfo)
{
  bmp_source_ptr source = (bmp_source_ptr) sinfo;
  U_CHAR bmpfileheader[14];
  U_CHAR bmpinfoheader[64];
#define GET_2B(array,offset)  ((unsigned short) UCH(array[offset]) + \
                               (((unsigned short) UCH(array[offset+1])) << 8))
#define GET_4B(array,offset)  ((unsigned int) UCH(array[offset]) + \
                               (((unsigned int) UCH(array[offset+1])) << 8) + \
                               (((unsigned int) UCH(array[offset+2])) << 16) + \
                               (((unsigned int) UCH(array[offset+3])) << 24))
  unsigned int bfOffBits;
  unsigned int headerSize;
  int biWidth;
  int biHeight;
  unsigned short biPlanes;
  unsigned int biCompression;
  int biXPelsPerMeter,biYPelsPerMeter;
  unsigned int biClrUsed = 0;
  int mapentrysize = 0;         /* 0 indicates no colormap */
  int bPad;
  JDIMENSION row_width;

  /* Read and verify the bitmap file header */
  if (! ReadOK(source->pub.input_file, bmpfileheader, 14))
    ERREXIT(cinfo, JERR_INPUT_EOF);
  if (GET_2B(bmpfileheader,0) != 0x4D42) /* 'BM' */
    ERREXIT(cinfo, JERR_BMP_NOT);
  bfOffBits = GET_4B(bmpfileheader,10);
  /* We ignore the remaining fileheader fields */

  /* The infoheader might be 12 bytes (OS/2 1.x), 40 bytes (Windows),
   * or 64 bytes (OS/2 2.x).  Check the first 4 bytes to find out which.
   */
  if (! ReadOK(source->pub.input_file, bmpinfoheader, 4))
    ERREXIT(cinfo, JERR_INPUT_EOF);
  headerSize = GET_4B(bmpinfoheader,0);
  if (headerSize < 12 || headerSize > 64)
    ERREXIT(cinfo, JERR_BMP_BADHEADER);
  if (! ReadOK(source->pub.input_file, bmpinfoheader+4, headerSize-4))
    ERREXIT(cinfo, JERR_INPUT_EOF);

  switch (headerSize) {
  case 12:
    /* Decode OS/2 1.x header (Microsoft calls this a BITMAPCOREHEADER) */
    biWidth = (int) GET_2B(bmpinfoheader,4);
    biHeight = (int) GET_2B(bmpinfoheader,6);
    biPlanes = GET_2B(bmpinfoheader,8);
    source->bits_per_pixel = (int) GET_2B(bmpinfoheader,10);

    switch (source->bits_per_pixel) {
    case 8:                     /* colormapped image */
      mapentrysize = 3;         /* OS/2 uses RGBTRIPLE colormap */
      TRACEMS2(cinfo, 1, JTRC_BMP_OS2_MAPPED, biWidth, biHeight);
      break;
    case 24:                    /* RGB image */
      TRACEMS2(cinfo, 1, JTRC_BMP_OS2, biWidth, biHeight);
      break;
    default:
      ERREXIT(cinfo, JERR_BMP_BADDEPTH);
      break;
    }
    break;
  case 40:
  case 64:
    /* Decode Windows 3.x header (Microsoft calls this a BITMAPINFOHEADER) */
    /* or OS/2 2.x header, which has additional fields that we ignore */
    biWidth = (int) GET_4B(bmpinfoheader,4);
    biHeight = (int) GET_4B(bmpinfoheader,8);
    biPlanes = GET_2B(bmpinfoheader,12);
    source->bits_per_pixel = (int) GET_2B(bmpinfoheader,14);
    biCompression = GET_4B(bmpinfoheader,16);
    biXPelsPerMeter = (int) GET_4B(bmpinfoheader,24);
    biYPelsPerMeter = (int) GET_4B(bmpinfoheader,28);
    biClrUsed = GET_4B(bmpinfoheader,32);
    /* biSizeImage, biClrImportant fields are ignored */

    switch (source->bits_per_pixel) {
    case 8:                     /* colormapped image */
      mapentrysize = 4;         /* Windows uses RGBQUAD colormap */
      TRACEMS2(cinfo, 1, JTRC_BMP_MAPPED, biWidth, biHeight);
      break;
    case 24:                    /* RGB image */
      TRACEMS2(cinfo, 1, JTRC_BMP, biWidth, biHeight);
      break;
    case 32:                    /* RGB image + Alpha channel */
      TRACEMS2(cinfo, 1, JTRC_BMP, biWidth, biHeight);
      break;
    default:
      ERREXIT(cinfo, JERR_BMP_BADDEPTH);
      break;
    }
    if (biCompression != 0)
      ERREXIT(cinfo, JERR_BMP_COMPRESSED);

    if (biXPelsPerMeter > 0 && biYPelsPerMeter > 0) {
      /* Set JFIF density parameters from the BMP data */
      cinfo->X_density = (UINT16) (biXPelsPerMeter/100); /* 100 cm per meter */
      cinfo->Y_density = (UINT16) (biYPelsPerMeter/100);
      cinfo->density_unit = 2;  /* dots/cm */
    }
    break;
  default:
    ERREXIT(cinfo, JERR_BMP_BADHEADER);
    return;
  }

  if (biWidth <= 0 || biHeight <= 0)
    ERREXIT(cinfo, JERR_BMP_EMPTY);
  if (biPlanes != 1)
    ERREXIT(cinfo, JERR_BMP_BADPLANES);

  /* Compute distance to bitmap data --- will adjust for colormap below */
  bPad = bfOffBits - (headerSize + 14);

  /* Read the colormap, if any */
  if (mapentrysize > 0) {
    if (biClrUsed <= 0)
      biClrUsed = 256;          /* assume it's 256 */
    else if (biClrUsed > 256)
      ERREXIT(cinfo, JERR_BMP_BADCMAP);
    /* Allocate space to store the colormap */
    source->colormap = (*cinfo->mem->alloc_sarray)
      ((j_common_ptr) cinfo, JPOOL_IMAGE,
       (JDIMENSION) biClrUsed, (JDIMENSION) 3);
source->cmap_length = (int) biClrUsed; 
    /* and read it from the file */
    read_colormap(source, (int) biClrUsed, mapentrysize);
    /* account for size of colormap */
    bPad -= biClrUsed * mapentrysize;
  }

  /* Skip any remaining pad bytes */
  if (bPad < 0)                 /* incorrect bfOffBits value? */
    ERREXIT(cinfo, JERR_BMP_BADHEADER);
  while (--bPad >= 0) {
    (void) read_byte(source);
  }

  /* Compute row width in file, including padding to 4-byte boundary */
  if (source->bits_per_pixel == 24)
    row_width = (JDIMENSION) (biWidth * 3);
  else if (source->bits_per_pixel == 32)
    row_width = (JDIMENSION) (biWidth * 4);
  else
    row_width = (JDIMENSION) biWidth;
  while ((row_width & 3) != 0) row_width++;
  source->row_width = row_width;

  /* Allocate space for inversion array, prepare for preload pass */
  source->whole_image = (*cinfo->mem->request_virt_sarray)
    ((j_common_ptr) cinfo, JPOOL_IMAGE, FALSE,
     row_width, (JDIMENSION) biHeight, (JDIMENSION) 1);
  source->pub.get_pixel_rows = preload_image;
  if (cinfo->progress != NULL) {
    cd_progress_ptr progress = (cd_progress_ptr) cinfo->progress;
    progress->total_extra_passes++; /* count file input as separate pass */
  }

  /* Ensure that biWidth * 3 doesn't exceed the maximum value of the
     JDIMENSION type.  This is only a danger with BMP files, since their width
     and height fields are 32-bit integers. */
  if ((unsigned long long)biWidth * 3ULL > 0xFFFFFFFFULL)
    ERREXIT(cinfo, JERR_WIDTH_OVERFLOW);
  /* Allocate one-row buffer for returned data */
  source->pub.buffer = (*cinfo->mem->alloc_sarray)
    ((j_common_ptr) cinfo, JPOOL_IMAGE,
     (JDIMENSION) (biWidth * 3), (JDIMENSION) 1);
  source->pub.buffer_height = 1;

  cinfo->in_color_space = JCS_RGB;
  cinfo->input_components = 3;
  cinfo->data_precision = 8;
  cinfo->image_width = (JDIMENSION) biWidth;
  cinfo->image_height = (JDIMENSION) biHeight;
}


/*
 * Finish up at the end of the file.
 */

METHODDEF(void)
finish_input_bmp (j_compress_ptr cinfo, cjpeg_source_ptr sinfo)
{
  /* no work */
}


/*
 * The module selection routine for BMP format input.
 */

GLOBAL(cjpeg_source_ptr)
jinit_read_bmp (j_compress_ptr cinfo)
{
  bmp_source_ptr source;

  /* Create module interface object */
  source = (bmp_source_ptr)
      (*cinfo->mem->alloc_small) ((j_common_ptr) cinfo, JPOOL_IMAGE,
                                  sizeof(bmp_source_struct));
  source->cinfo = cinfo;        /* make back link for subroutines */
  /* Fill in method ptrs, except get_pixel_rows which start_input sets */
  source->pub.start_input = start_input_bmp;
  source->pub.finish_input = finish_input_bmp;

  return (cjpeg_source_ptr) source;
}

#endif /* BMP_SUPPORTED */
